<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAFS 狀元工廠 (MC Master)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Comic Neue for Cartoon feel -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'cartoon': ['"Comic Neue"', 'cursive'],
                        'body': ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        'brand-yellow': '#FFD93D',
                        'brand-blue': '#4D96FF',
                        'brand-green': '#6BCB77',
                        'brand-red': '#FF6B6B',
                        'brand-dark': '#2D2D2D',
                    },
                    boxShadow: {
                        'cartoon': '4px 4px 0px 0px #000000',
                        'cartoon-sm': '2px 2px 0px 0px #000000',
                        'cartoon-hover': '6px 6px 0px 0px #000000',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
        }
        
        .cartoon-font {
            font-family: 'Comic Neue', cursive;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-left: 2px solid black;
        }
        ::-webkit-scrollbar-thumb {
            background: #4D96FF;
            border: 2px solid black;
            border-radius: 10px;
        }

        /* Animations */
        @keyframes bounce-small {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-bounce-hover:hover {
            animation: bounce-small 0.5s infinite;
        }

        .cartoon-card {
            border: 3px solid black;
            border-radius: 1rem;
            box-shadow: 4px 4px 0px 0px #000000;
            transition: all 0.2s ease;
            background-color: white;
        }

        .dark .cartoon-card {
            background-color: #374151; /* gray-700 */
            box-shadow: 4px 4px 0px 0px #ffffff;
            border-color: white;
        }

        .cartoon-btn {
            border: 2px solid black;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 3px 3px 0px 0px #000000;
            transition: all 0.1s;
        }
        .cartoon-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px 0px #000000;
        }

        .dark .cartoon-btn {
            box-shadow: 3px 3px 0px 0px #ffffff;
            border-color: white;
        }
        
        /* Checkbox styling */
        .option-input:checked + div {
            background-color: #4D96FF;
            color: white;
            border-color: black;
            box-shadow: inset 2px 2px 0px 0px rgba(0,0,0,0.2);
        }

        .hidden-page {
            display: none;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 9999;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
        
        /* Pre-formatted text for questions to preserve newlines */
        .question-text {
            white-space: pre-line;
        }
    </style>
</head>
<body class="bg-yellow-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white dark:bg-gray-800 border-b-4 border-black dark:border-white px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2 cursor-pointer" onclick="app.router('home')">
            <i class="fa-solid fa-graduation-cap text-3xl text-brand-blue dark:text-brand-yellow drop-shadow-[2px_2px_0_rgba(0,0,0,1)]"></i>
            <h1 class="text-2xl font-bold cartoon-font tracking-wider">BAFS <span class="text-brand-blue dark:text-brand-yellow">MC</span> 工廠</h1>
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="app.toggleDarkMode()" class="p-2 rounded-full border-2 border-black dark:border-white hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <i class="fa-solid fa-moon dark:hidden"></i>
                <i class="fa-solid fa-sun hidden dark:block text-brand-yellow"></i>
            </button>
            
            <!-- Auth Status (Anonymous) -->
            <div id="user-display" class="hidden flex items-center gap-2 text-sm font-bold border-2 border-black dark:border-white px-3 py-1 rounded-full bg-brand-green text-white shadow-cartoon-sm">
                <i class="fa-solid fa-user-secret"></i> <span id="username-span">訪客</span>
            </div>

            <!-- Mobile Menu Button -->
            <button class="md:hidden cartoon-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden fixed inset-0 z-40 bg-black/90 flex flex-col items-center justify-center space-y-6 text-white text-2xl font-bold cartoon-font">
        <button class="absolute top-5 right-5 text-4xl" onclick="document.getElementById('mobile-menu').classList.add('hidden')">&times;</button>
        <a href="#" onclick="app.router('home'); document.getElementById('mobile-menu').classList.add('hidden')">主頁</a>
        <a href="#" onclick="app.router('mistakes'); document.getElementById('mobile-menu').classList.add('hidden')">我的錯題本</a>
        <a href="#" onclick="app.router('leaderboard'); document.getElementById('mobile-menu').classList.add('hidden')">龍虎榜</a>
    </div>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-4 max-w-4xl relative">
        
        <!-- === HOME VIEW === -->
        <div id="home-view" class="space-y-8 animate-fade-in">
            <!-- Hero Section -->
            <div class="cartoon-card bg-brand-blue text-white p-6 md:p-10 text-center relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/20 rounded-full"></div>
                <div class="absolute top-20 -left-10 w-20 h-20 bg-brand-yellow/30 rounded-full"></div>
                <h2 class="text-3xl md:text-5xl font-bold mb-4 cartoon-font drop-shadow-[3px_3px_0_rgba(0,0,0,1)]">BAFS 5** 生成器</h2>
                <p class="text-lg md:text-xl font-medium mb-6">歷屆試題 • 即時詳解 • 錯題重溫 • 龍虎榜</p>
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="app.startRandomMock()" class="cartoon-btn bg-brand-yellow text-black px-6 py-3 rounded-xl text-lg hover:bg-yellow-300">
                        <i class="fa-solid fa-shuffle mr-2"></i>隨機模擬卷 (24題)
                    </button>
                    <button onclick="app.startMiniQuiz()" class="cartoon-btn bg-purple-500 text-white px-6 py-3 rounded-xl text-lg hover:bg-purple-600 shadow-cartoon">
                        <i class="fa-solid fa-stopwatch mr-2"></i>極速小測 (20題)
                    </button>
                    <button onclick="app.router('mistakes')" class="cartoon-btn bg-brand-red text-white px-6 py-3 rounded-xl text-lg hover:bg-red-500">
                        <i class="fa-solid fa-book-skull mr-2"></i>重溫錯題
                    </button>
                </div>
            </div>

            <!-- Loading Status for External Data -->
            <div id="external-loading-bar" class="hidden cartoon-card p-4 bg-blue-100 dark:bg-blue-900 border-2 border-brand-blue flex items-center justify-center gap-3">
                <i class="fa-solid fa-cloud-arrow-down fa-bounce text-brand-blue dark:text-brand-yellow text-xl"></i>
                <span class="font-bold">正在從 GitHub 載入更多題目...</span>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="cartoon-card p-4 text-center bg-white dark:bg-gray-800">
                    <div class="text-3xl font-bold text-brand-blue" id="stat-total-done">0</div>
                    <div class="text-sm font-bold text-gray-500 dark:text-gray-300">已做題數</div>
                </div>
                <div class="cartoon-card p-4 text-center bg-white dark:bg-gray-800">
                    <div class="text-3xl font-bold text-brand-green" id="stat-accuracy">0%</div>
                    <div class="text-sm font-bold text-gray-500 dark:text-gray-300">總正確率</div>
                </div>
                <div class="cartoon-card p-4 text-center bg-white dark:bg-gray-800">
                    <div class="text-3xl font-bold text-brand-red" id="stat-mistakes">0</div>
                    <div class="text-sm font-bold text-gray-500 dark:text-gray-300">待改錯題</div>
                </div>
                <div class="cartoon-card p-4 text-center bg-white dark:bg-gray-800 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" onclick="app.router('leaderboard')">
                    <div class="text-3xl font-bold text-brand-yellow"><i class="fa-solid fa-trophy"></i></div>
                    <div class="text-sm font-bold text-gray-500 dark:text-gray-300">龍虎榜</div>
                </div>
            </div>

            <!-- Year Selection -->
            <div>
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <span class="w-4 h-8 bg-brand-blue rounded-full block"></span>
                    年份練習
                </h3>
                <div class="grid grid-cols-3 md:grid-cols-5 gap-4" id="year-grid">
                    <!-- JS will populate this -->
                    <div class="col-span-3 text-center py-8 text-gray-400">正在載入題庫...</div>
                </div>
            </div>
        </div>

        <!-- === QUIZ VIEW === -->
        <div id="quiz-view" class="hidden-page pb-20">
            <!-- Quiz Header -->
            <div class="flex justify-between items-center mb-6 bg-white dark:bg-gray-800 p-4 border-b-4 border-black dark:border-white sticky top-16 z-30">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-widest" id="quiz-mode-label">PRACTICE MODE</span>
                    <h2 class="text-xl font-bold" id="quiz-title">2023 DSE</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div id="timer-display" class="text-xl font-mono font-bold bg-black text-brand-green px-3 py-1 rounded border-2 border-gray-500 hidden">
                        75:00
                    </div>
                    <button onclick="app.endQuizEarly()" class="text-sm underline text-red-500 font-bold">結束練習</button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 h-4 border-2 border-black rounded-full mb-6 relative overflow-hidden">
                <div id="quiz-progress" class="bg-brand-blue h-full transition-all duration-300" style="width: 0%"></div>
            </div>

            <!-- Question Card -->
            <div class="cartoon-card p-6 md:p-8 mb-6 relative bg-white dark:bg-gray-800">
                <!-- Top Badges Row -->
                <div class="flex justify-between items-start mb-4">
                    <!-- Progress Badge -->
                    <div class="bg-brand-yellow border-2 border-black px-3 py-1 font-bold rounded-lg shadow-sm">
                        Q<span id="q-number">1</span>
                    </div>
                    <!-- Source Year Badge -->
                    <div class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs font-bold px-3 py-1 rounded-full border border-gray-400">
                        <i class="fa-solid fa-tag mr-1"></i><span id="q-source">2024 Q1</span>
                    </div>
                </div>
                
                <div class="mt-2 mb-6 text-lg md:text-xl font-medium leading-relaxed question-text" id="q-text">
                    Loading question...
                </div>

                <!-- Options -->
                <div class="space-y-3" id="q-options">
                    <!-- Options injected by JS -->
                </div>

                <!-- Explanation Box (Hidden initially) -->
                <div id="explanation-box" class="hidden mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 border-l-4 border-brand-blue rounded-r-lg animate-fade-in">
                    <h4 class="font-bold text-brand-blue mb-1"><i class="fa-solid fa-lightbulb mr-2"></i>詳解：</h4>
                    <p class="text-sm md:text-base text-gray-700 dark:text-gray-300" id="explanation-text"></p>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex justify-between items-center mb-8">
                <button id="btn-prev" onclick="app.prevQuestion()" class="cartoon-btn bg-gray-200 dark:bg-gray-700 px-6 py-3 rounded-xl disabled:opacity-50">
                    <i class="fa-solid fa-arrow-left"></i> 上一題
                </button>
                
                <button id="btn-next" onclick="app.nextQuestion()" class="cartoon-btn bg-brand-blue text-white px-8 py-3 rounded-xl shadow-cartoon hover:bg-blue-600 hidden">
                    下一題 <i class="fa-solid fa-arrow-right"></i>
                </button>
                
                <button id="btn-submit" onclick="app.submitQuiz()" class="cartoon-btn bg-brand-green text-white px-8 py-3 rounded-xl shadow-cartoon hover:bg-green-600 hidden">
                    提交試卷 <i class="fa-solid fa-check"></i>
                </button>
            </div>

            <!-- Chatbox Section -->
            <div class="mt-8 pt-8 border-t-4 border-dashed border-gray-300 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-comments text-brand-blue"></i> 同學討論區
                </h3>
                <div class="w-full bg-white dark:bg-gray-800 rounded-xl overflow-hidden border-2 border-black shadow-cartoon-sm">
                    <script id="cid0020000427496639107" data-cfasync="false" async src="//st.chatango.com/js/gz/emb.js" style="width: 100%;height: 500px;">{"handle":"swcs-bafs","arch":"js","styles":{"a":"C8C8C8","b":100,"c":"000000","d":"000000","k":"C8C8C8","l":"C8C8C8","m":"C8C8C8","p":"10","q":"C8C8C8","r":100,"t":0,"surl":0,"allowpm":0,"fwtickm":1}}</script>
                </div>
            </div>
        </div>

        <!-- === RESULT VIEW === -->
        <div id="result-view" class="hidden-page text-center pt-10">
            <h2 class="text-4xl font-bold mb-2 cartoon-font">成績單</h2>
            <p class="text-gray-500 mb-8" id="result-subtitle">2023 DSE • Practice Mode</p>

            <div class="cartoon-card p-8 bg-white dark:bg-gray-800 mb-8 inline-block w-full max-w-md">
                <div class="flex justify-center mb-6">
                    <div class="relative w-40 h-40 flex items-center justify-center rounded-full border-8 border-brand-blue" id="score-circle">
                        <div class="text-center">
                            <div class="text-4xl font-bold" id="result-score">40</div>
                            <div class="text-sm text-gray-500">/ <span id="result-total">45</span></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-lg border-2 border-green-200 dark:border-green-800">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="result-correct">0</div>
                        <div class="text-xs uppercase font-bold text-green-800 dark:text-green-200">正確</div>
                    </div>
                    <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-lg border-2 border-red-200 dark:border-red-800">
                        <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="result-wrong">0</div>
                        <div class="text-xs uppercase font-bold text-red-800 dark:text-red-200">錯誤</div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <div id="auto-upload-msg" class="text-sm text-green-600 font-bold hidden mb-2">
                        <i class="fa-solid fa-check"></i> 成績已自動上傳至龍虎榜
                    </div>
                    <!-- Manual upload button as backup -->
                    <button onclick="app.saveToLeaderboard(false)" class="cartoon-btn bg-brand-yellow w-full py-3 rounded-xl font-bold hover:bg-yellow-300">
                        <i class="fa-solid fa-trophy mr-2"></i>上傳分數至龍虎榜
                    </button>
                    <button onclick="app.shareResult()" class="cartoon-btn bg-gray-100 dark:bg-gray-700 dark:text-white w-full py-3 rounded-xl font-bold hover:bg-gray-200">
                        <i class="fa-solid fa-share-nodes mr-2"></i>分享成績
                    </button>
                </div>
            </div>

            <div class="flex justify-center gap-4">
                <button onclick="app.router('home')" class="cartoon-btn bg-white dark:bg-gray-700 px-6 py-3 rounded-xl">回到主頁</button>
                <button onclick="app.router('mistakes')" class="cartoon-btn bg-brand-red text-white px-6 py-3 rounded-xl">查看錯題</button>
            </div>
        </div>

        <!-- === MISTAKES VIEW === -->
        <div id="mistakes-view" class="hidden-page">
            <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                <i class="fa-solid fa-book-skull text-brand-red"></i> 我的錯題本
                <button onclick="app.clearMistakes()" class="text-sm bg-red-100 text-red-600 px-3 py-1 rounded-full border border-red-300 hover:bg-red-200 ml-auto">
                    清除所有
                </button>
            </h2>
            <div id="mistakes-list" class="space-y-6">
                <!-- Injected via JS -->
            </div>
            <div id="no-mistakes-msg" class="text-center py-20 hidden">
                <i class="fa-solid fa-check-circle text-6xl text-green-300 mb-4"></i>
                <p class="text-xl font-bold text-gray-500">太強了！目前沒有錯題。</p>
                <button onclick="app.router('home')" class="mt-4 cartoon-btn bg-brand-blue text-white px-6 py-2 rounded-lg">去練習</button>
            </div>
        </div>

        <!-- === LEADERBOARD VIEW === -->
        <div id="leaderboard-view" class="hidden-page">
            <div class="text-center mb-8 relative">
                <h2 class="text-3xl font-bold cartoon-font bg-brand-yellow inline-block px-6 py-2 border-4 border-black rotate-[-2deg] shadow-cartoon">BAFS 龍虎榜</h2>
                <p class="mt-4 text-gray-500">Top 50 Legends</p>
                <button onclick="app.loadLeaderboard()" class="absolute right-0 top-2 text-sm bg-white border border-gray-300 px-3 py-1 rounded shadow hover:bg-gray-50">
                    <i class="fa-solid fa-rotate"></i> 刷新
                </button>
            </div>

            <div class="cartoon-card overflow-hidden bg-white dark:bg-gray-800">
                <table class="w-full text-left">
                    <thead class="bg-black text-white">
                        <tr>
                            <th class="p-4">排名</th>
                            <th class="p-4">狀元</th>
                            <th class="p-4 hidden md:table-cell">年份/模式</th>
                            <th class="p-4 text-right">分數</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- JS injected -->
                    </tbody>
                </table>
            </div>
            <button onclick="app.router('home')" class="mt-8 cartoon-btn bg-white dark:bg-gray-700 w-full py-3 rounded-xl">返回</button>
        </div>

    </main>

    <!-- Footer -->
    <footer class="text-center py-8 text-gray-400 text-xs mt-auto">
        <p>BAFS MC Master © 2024</p>
    </footer>

    <!-- Modal for Mode Selection -->
    <div id="mode-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl p-6 border-4 border-black shadow-[8px_8px_0_0_#fff]">
            <h3 class="text-2xl font-bold mb-2">選擇模式</h3>
            <p class="text-gray-500 mb-6" id="modal-year-title">2023 Year</p>
            
            <div class="space-y-4">
                <button onclick="app.startQuiz('practice')" class="w-full cartoon-card p-4 hover:bg-green-50 dark:hover:bg-green-900/20 flex items-center gap-4 group">
                    <div class="bg-brand-green text-white w-12 h-12 rounded-full flex items-center justify-center border-2 border-black group-hover:scale-110 transition">
                        <i class="fa-solid fa-dumbbell"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-lg">練習模式</div>
                        <div class="text-xs text-gray-500">即時答案 • 無計時 • 輕鬆做</div>
                    </div>
                </button>

                <button onclick="app.startQuiz('exam')" class="w-full cartoon-card p-4 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-4 group">
                    <div class="bg-brand-red text-white w-12 h-12 rounded-full flex items-center justify-center border-2 border-black group-hover:scale-110 transition">
                        <i class="fa-solid fa-stopwatch"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-lg">模擬考模式</div>
                        <div class="text-xs text-gray-500">30分鐘倒數 • 最後對卷 • 真實體驗</div>
                    </div>
                </button>
            </div>
            
            <button onclick="document.getElementById('mode-modal').classList.add('hidden')" class="mt-6 w-full py-3 text-gray-500 font-bold hover:text-black">取消</button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full shadow-lg translate-y-20 transition-transform duration-300 z-50 flex items-center gap-2">
        <i class="fa-solid fa-info-circle text-brand-yellow"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === 1. 靜態題庫資料庫 (2024-2020) ===
        // 請注意：目前只保留2020-2024題目於此。
        // 如果您希望加入2012-2019，請使用下方的 GitHub 連結功能。
        const REAL_QUESTIONS = [
            // 2024 Questions ... (kept from previous, truncated for brevity in this response)
           { id: 202401, year: "2024", topic: "Business Environment", question: "下列哪項是商界對香港經濟的貢獻？ (1) 銷售貨品與服務至海外以賺取外匯 (2) 為本地居民提供就業機會 (3) 為政府帶來稅收", options: ["只有 (1) 及 (2)", "只有 (1) 及 (3)", "只有 (2) 及 (3)", "(1)、(2) 及 (3)"], answer: 3, explanation: "商界的三大經濟貢獻包括：賺取外匯、創造就業機會以及透過利得稅等形式為政府提供收入，故三項皆正確。" },
        { id: 202101, year: "2021", topic: "Business Environment", question: "下列哪項有關世界貿易組織的陳述是正確的？ (1) 它執行成員之間的國際貿易規則。 (2) 它協助發展中國家增加貿易機會。 (3) 它消除成員之間的貿易障礙。", options: ["只有 (1)", "只有 (1) 及 (2)", "只有 (2) 及 (3)", "(1)、(2) 及 (3)"], answer: 1, explanation: "世貿組織負責執行貿易協定及協助發展中國家 (1, 2對)；其目標是「減少」而非完全「消除」所有障礙 (3略有保留，但在DSE常規中，消除所有障礙通常被視為過於絕對，且選項B為最佳答案)。" },
        { id: 202102, year: "2021", topic: "Management", question: "按產品劃分部門的意思是指：", options: ["不同部門服務不同國家的顧客", "為不同市場發展不同的產品線", "工人按生產程序分工", "產品的生產、市場營銷及其他相關工作均由一位經理負責"], answer: 3, explanation: "按產品劃分部門 (Product Departmentalization) 意味著圍繞特定產品將所有相關職能（如生產、營銷）歸於同一部門管理。" },
        { id: 202103, year: "2021", topic: "Accounting", question: "一家零售店的簿記員於年終時結平帳戶，列出帳戶結餘，並編製試算表。該簿記員執行了以下哪項會計功能？", options: ["記錄", "分類", "歸納", "溝通"], answer: 2, explanation: "編製試算表是將分類帳資料進行匯總，屬於「歸納」 (Summarizing) 階段。" },
        { id: 202104, year: "2021", topic: "Finance", question: "文妮正考慮一項三年期的投資項目，詳情如下：第一年初流出 $70,000；第二年初流入 $25,000；第三年初流入 $35,000。該項目終結時的殘值為 20,000，貼現率為每年 5%。該項目的淨現值是多少？", options: ["-$14,445", "$187", "$2,832", "$3,520"], answer: 2, explanation: "計算現值：-$70,000 + $25,000/1.05 + $35,000/(1.05^2) + $20,000/(1.05^3) ≈ $2,832。" },
        { id: 202105, year: "2021", topic: "Management", question: "下列哪項不是授權的好處？", options: ["提高下屬的工作滿足感", "改善上司與下屬的關係", "為下屬提供培訓機會", "讓上司專注於重要的工作"], answer: 1, explanation: "授權的主要好處包括激勵下屬 (A)、培訓 (C) 及讓上司專注策略 (D)。雖然可能有助關係，但在考試標準答案中，改善關係通常不是授權的直接或主要定義性好處。" },
{ id: 202106, year: "2021", topic: "Accounting", question: "2021 年 2 月 1 日，李先生及成立一家售賣電腦的零售商號。同日，該商號從供應商賒購十台電腦，每台成本 $4,500。在 2 月，這商號把兩台損壞的電腦退回供應商，並售出三台電腦，每台售價 $7,000。2021 年 2 月 28 日，該商號購貨帳的結餘是多少？", options: ["$22,500", "$31,500", "$36,000", "$45,000"], answer: 3, explanation: "購貨帳只記錄購買成本：10 台 x $4,500 = $45,000。退貨記在「購貨退出帳」，銷貨記在「銷貨帳」，不影響購貨帳餘額。" },
{ id: 202107, year: "2021", topic: "Business Environment", question: "下列哪項是影響一家香港餐館營運的法律因素？ (1) 最低工資水平上調。 (2) 因 2019 冠狀病毒病擴散，公眾地方羣組聚集的人數受到限制。 (3) 消費物價指數下降。", options: ["只有 (1)", "只有 (2)", "只有 (3)", "只有 (1) 及 (2)"], answer: 3, explanation: "最低工資 (1) 及限聚令 (2) 均屬法律/法規因素。CPI (3) 屬經濟因素。" },
{ id: 202108, year: "2021", topic: "Management", question: "下列哪項有關有效管理原則所帶來的好處是正確的？", options: ["平衡職權和責任 —— 改善員工之間的溝通", "分工 —— 減少生產延誤", "統一命令 —— 減少工作混亂", "目標管理 —— 減少行政工作"], answer: 2, explanation: "統一命令 (Unity of Command) 確保員工只受一人指揮，能減少混亂 (C對)。目標管理通常會增加行政/文書工作 (D錯)。" },
{ id: 202109, year: "2021", topic: "Accounting", question: "2020 年 12 月 31 日，李氏商號的帳戶結餘如下：應收帳款 $55,000；銀行透支 $2,500；存貨 $21,200；貸款予陳先生 $18,000；現金 $23,000；應付帳款 $42,300；設備 $121,000。2020 年 12 月 31 日資本帳的結餘是多少？", options: ["$157,400", "$162,400", "$193,400", "$198,400"], answer: 2, explanation: "資產 = 55,000+21,200+18,000+23,000+121,000 = $238,200。負債 = 2,500+42,300 = $44,800。資本 = 資產 - 負債 = $193,400。" },
{ id: 202110, year: "2021", topic: "Finance", question: "下列哪項是銀行透支與私人貸款的分別？", options: ["利率：銀行透支較低，私人貸款較高", "還款安排：銀行透支靈活，私人貸款固定", "預先批核信貸額：銀行透支沒有，私人貸款有", "每月最低還款額：銀行透支有，私人貸款沒有"], answer: 1, explanation: "透支還款靈活 (隨時存入即可)，私人貸款通常需分期定額還款 (B對)。透支利率通常較高 (A錯)。" },
{ id: 202111, year: "2021", topic: "Accounting", question: "下列哪項會減少商號的毛利？ (1) 提用貨品 (2) 購貨運費增加 (3) 電費增加", options: ["只有 (1)", "只有 (2)", "只有 (3)", "只有 (1) 及 (2)"], answer: 1, explanation: "購貨運費 (Carriage Inwards) 增加銷貨成本，從而減少毛利 (2對)。電費只影響淨利 (3錯)。提用貨品會扣減購貨，反而避免了毛利被低估，不會減少毛利 (1錯)。" },
{ id: 202112, year: "2021", topic: "Business Environment", question: "下列哪項是公營公司的特徵？ (1) 政府參與日常營運。 (2) 董事局主席由政府委任。 (3) 它是獨立的法定個體。", options: ["只有 (1) 及 (2)", "只有 (1) 及 (3)", "只有 (2) 及 (3)", "(1)、(2) 及 (3)"], answer: 2, explanation: "公營公司 (如機管局) 是獨立法定個體，主席由政府委任，但政府通常不直接參與「日常」營運 (1錯)。" },
{ id: 202113, year: "2021", topic: "Accounting", question: "下列哪項有關試算表的陳述是正確的？ (1) 如試算表平衡，帳戶結餘沒有錯誤。 (2) 試算表顯示所有帳戶的結餘。 (3) 如帳戶的借方總額較貸方總額少，這帳戶的結餘會顯示在試算表的貸方列。", options: ["只有 (1)", "只有 (2)", "只有 (1) 及 (3)", "只有 (2) 及 (3)"], answer: 3, explanation: "平衡不代表無誤 (1錯)。試算表列出所有帳戶結餘 (2對)。借方 < 貸方 = 貸方餘額 (Credit Balance)，列在貸方列 (3對)。" },
{ id: 202114, year: "2021", topic: "Finance", question: "下列哪項對個人的信貸評級有負面影響？ (1) 有破產紀錄 (2) 曾經沒有如期償還貸款 (3) 失業超過一年", options: ["只有 (1) 及 (2)", "只有 (1) 及 (3)", "只有 (2) 及 (3)", "(1)、(2) 及 (3)"], answer: 0, explanation: "信貸評級主要基於過往信貸紀錄 (破產、遲還款)。失業本身不直接記錄在信貸報告 (TU) 中，雖然銀行審批時會考慮，但不屬於信貸評級機構的評分項目。" },
{ id: 202115, year: "2021", topic: "Accounting", question: "下列哪項有關財務狀況表的陳述是正確的？ (1) 它顯示商號的變現能力。 (2) 非流動資產按其總額由大至小排列。 (3) 它顯示商號某段時間的財務狀況。", options: ["只有 (1)", "只有 (2)", "只有 (1) 及 (3)", "只有 (2) 及 (3)"], answer: 0, explanation: "財務狀況表顯示某「時點」(As at) 的狀況而非某段時間 (3錯)。資產按流動性/持久性排列，非金額大小 (2錯)。透過營運資金可顯示變現能力 (1對)。" },
{ id: 202116, year: "2021", topic: "Business Environment", question: "下列哪家商號在 2019 冠狀病毒病擴散下向持份者履行社會責任？ (1) 一家室內設計公司容許僱員在家工作。 (2) 一家餐館向堂食顧客提供折扣。 (3) 一家出版社讓公眾經互聯網免費閱讀其書本。", options: ["只有 (1) 及 (2)", "只有 (1) 及 (3)", "只有 (2) 及 (3)", "(1)、(2) 及 (3)"], answer: 1, explanation: "在家工作保障員工 (1)，免費閱讀回饋社會 (3)。疫情下鼓勵堂食 (2) 可能增加傳播風險，未必被視為履行社會責任的正面例子。" },
{ id: 202117, year: "2021", topic: "Management", question: "一家新成立的電動車製造商設定目標如下：「我們將在下半年成為電動車市場的領導者。」這目標符合以下哪項良好目標的準則？ (1) 具體的 (2) 具時限的 (3) 可量度的", options: ["只有 (1)", "只有 (2)", "只有 (3)", "只有 (1) 及 (2)"], answer: 1, explanation: "「下半年」具時限性 (2)。但「市場領導者」定義含糊 (市佔率？利潤？)，欠缺具體數字指標，故不夠具體 (1) 和可量度 (3)。" },
{ id: 202118, year: "2021", topic: "Accounting", question: "2020 年 12 月 31 日，新輝公司決定於三個月後結束營業。同日，它的非流動資產記錄為 $3,800,000，而其清算值則為 $2,098,000。根據哪項會計概念，新輝公司於財務狀況表中的資產計值應為多少？", options: ["繼續經營假設 …… $2,098,000", "繼續經營假設 …… $3,800,000", "歷史成本概念 …… $2,098,000", "歷史成本概念 …… $3,800,000"], answer: 0, explanation: "因公司將結束，繼續經營假設 (Going Concern) 不再適用。因此，資產應以變現淨值 ($2,098,000) 入帳。這決定是基於對「繼續經營假設」狀態的評估（即因為該假設被推翻）。" },
{ id: 202119, year: "2021", topic: "Business Environment", question: "企業編製道德守則的主要原因是甚麼？", options: ["法例規定", "可以降低生產成本", "可以改善公司的形象，賺取最高利潤", "為僱員提供規則和標準"], answer: 3, explanation: "道德守則的主要目的是為員工提供行為指引、規則和標準 (D)。" },
{ id: 202120, year: "2021", topic: "Business Environment", question: "下列哪項有關強制性公積金（強積金）制度的陳述是正確的？ (1) 僱員可在強制供款以外，向強積金計劃作出自願性供款。 (2) 林先生是一名司機，現年 68 歲，月入 $10,000，他須向強積金計劃每月供款 $500。 (3) 陳先生是一名自僱小販，去年淨收入為 $120,000，他須向強積金計劃供款 $6,000。", options: ["只有 (1)", "只有 (1) 及 (2)", "只有 (1) 及 (3)", "(2) 及 (3)"], answer: 0, explanation: "自願供款是允許的 (1對)。65 歲以上獲豁免 (2錯)。雖然 (3) 看似計算正確 (120k * 5% = 6k)，但DSE答案指出只有 (1) 正確，可能因題目細節定義（如小販豁免或「淨收入」字眼非「有關入息」）而不成立。" },
{ id: 202121, year: "2021", topic: "Business Environment", question: "下列哪項有關香港中小型企業（中小企）的陳述是正確的？", options: ["中小企的規模較細，未能實行分工。", "東主承擔有限債務責任。", "大多數中小企從事次級產業。", "聘用少於 50 名員工的非製造業公司屬中小企。"], answer: 3, explanation: "這是香港政府對非製造業中小企的定義 (D對)。中小企多為第三級產業 (C錯)，且多為無限公司 (B錯)。" },
{ id: 202122, year: "2021", topic: "Accounting", question: "截至 2020 年 12 月 31 日止年度，順記（銷貨 $8,800k、銷貨成本 $2,400k、營業費用 $2,800k）與錦記（銷貨 $15,000k、銷貨成本 $2,600k、營業費用 $9,800k）的資料比較，下列哪項陳述是正確的？", options: ["錦記的毛利較低。", "錦記的運用資金報酬率較高。", "錦記在控制營業費用的表現較佳。", "錦記的淨利率較低。"], answer: 3, explanation: "順記淨利率 = 3600/8800 = 40.9%；錦記淨利率 = 2600/15000 = 17.3%。故錦記淨利率較低 (D對)。" },
{ id: 202123, year: "2021", topic: "Finance", question: "下列哪項有關債券的陳述是正確的？ (1) 承擔風險能力較低的投資者通常偏向投資債券多於股票。 (2) 如市場利率上升，債券持有人會收取較高利息。 (3) 債券持有人可於到期日取回本金。", options: ["只有 (1) 及 (2)", "只有 (1) 及 (3)", "只有 (2) 及 (3)", "(1)、(2) 及 (3)"], answer: 1, explanation: "債券風險通常低於股票 (1對)。債券票面息率固定，不隨市場利率上升而增加 (市場利率升會導致債價跌) (2錯)。到期取回本金 (3對)。" },
{ id: 202124, year: "2021", topic: "Business Environment", question: "下列哪項是全球一體化對香港的好處？ (1) 較易從海外招聘專家 (2) 較便宜的原料供應 (3) 減少企業之間的競爭", options: ["只有 (1)", "只有 (2)", "只有 (3)", "只有 (1) 及 (2)"], answer: 3, explanation: "全球化促進人才流動 (1) 和採購 (2)。但通常會加劇而非減少競爭 (3錯)。" },
{ id: 202125, year: "2021", topic: "Management", question: "一家工廠的生產經理決定在 2021 年底前生產 1,000 件貨品。他已安排生產日程，並調配所需資源及人手。在計劃過程中，下一個步驟是甚麼？", options: ["評估可行方案", "制訂行動方案", "執行行動方案", "設定目標"], answer: 2, explanation: "既然已決定目標並安排好資源/方案 (Organizing/Planning done)，下一步就是「執行」(Implementation)。" },
{ id: 202126, year: "2021", topic: "Accounting", question: "下列哪項複式記帳是正確的？ (1) 以支票向銀光公司購買一輛汽車：借「汽車」、貸「銀光公司」 (2) 從梁先生取得佣金支票：借「銀行存款」、貸「佣金收益」 (3) 東主以其個人支票支付商號的租金費用：借「租金費用」、貸「資本」", options: ["只有 (1)", "只有 (2)", "只有 (2) 及 (3)", "(1)、(2) 及 (3)"], answer: 2, explanation: "(1) 支票付款應貸記「銀行存款」而非供應商。(2) 及 (3) 正確。" },
{ id: 202127, year: "2021", topic: "Finance", question: "彭力剛剛退休。他欲以公積金作投資，賺取穩定的收益。下列哪項投資工具最適合他？", options: ["恆生指數成分股", "在 GEM 上市的股票", "定期存款", "儲蓄存款"], answer: 2, explanation: "退休人士首重本金安全及穩定收益。定期存款 (C) 符合低風險及穩定利息。股票 (A, B) 風險較高，儲蓄存款 (D) 回報過低。" },
{ id: 202128, year: "2021", topic: "Management", question: "一家內地凍肉食品公司擬在香港開設分店。下列哪項是公司資訊管理經理可給予市場營銷經理的支援？ (1) 處理有關香港凍肉食品市場的數據 (2) 蒐集冷藏系統供應商的資料 (3) 建立銷售人員的薪酬制度", options: ["只有 (1)", "只有 (1) 及 (2)", "只有 (1) 及 (3)", "(1)、(2) 及 (3)"], answer: 0, explanation: "資訊經理負責處理數據與系統 (1)。冷藏系統是採購或營運部，薪酬是人力資源部。" },
{ id: 202129, year: "2021", topic: "Accounting", question: "下列哪項是實帳戶的例子？", options: ["購貨帳", "應收貨款帳", "銷貨折扣帳", "電費帳"], answer: 1, explanation: "實帳戶 (Real Account) 涉及資產。應收貨款 (Asset) 是實帳戶。其他均為虛帳戶 (Nominal Accounts)。" },
{ id: 202130, year: "2021", topic: "Finance", question: "假如某投資項目的利息每半年以複息計算，下列哪項有關該項目名義回報率與實際回報率的陳述是正確的？ (1) 該項目的實際回報率較其名義回報率高。 (2) 如該項目的利息改為每季以複息計算，實際回報率會更高。 (3) 如投資金額降低，該項目的實際回報率亦會降低。", options: ["只有 (1) 及 (2)", "只有 (1) 及 (3)", "只有 (2) 及 (3)", "(1)、(2) 及 (3)"], answer: 0, explanation: "複息頻率多於一年一次，EAR > APR (1對)。頻率越高 (每季 > 每半年)，EAR 越高 (2對)。回報率與投資本金金額無關 (3錯)。" }
            
            // 2023 Questions
            { id: 202301, year: "2023", topic: "Business Environment", question: "下列哪項有關香港營商環境的陳述是正確的？\n(1) 香港天然資源豐富，可以自給自足。\n(2) 香港大多數進口的貨物來自內地。\n(3) 香港政府沒有對貨物徵收銷售稅。", options: ["只有 (1)", "只有 (2)", "只有 (1) 及 (3)", "只有 (2) 及 (3)"], answer: 3, explanation: "香港缺乏天然資源(1錯)；內地是香港主要進口來源地(2對)；香港奉行簡單稅制，沒有徵收銷售稅(3對)。" },
            // ... (Other 2023 questions) ...

            // 2022 Questions
            { id: 202201, year: "2022", topic: "Business Environment", question: "下列哪項有關香港營商環境的陳述是正確的？\n(1) 香港是亞太區經濟合作組織及世界貿易組織的成員。\n(2) 香港的本地生產總值主要來自第二級產業。\n(3) 在香港賺取利潤的企業須繳納薪俸稅。", options: ["只有 (1)", "只有 (2)", "只有 (3)", "只有 (1) 及 (2)"], answer: 0, explanation: "香港是亞太經合組織 (APEC) 及世貿 (WTO) 成員 (1對)；GDP 主要來自第三級服務業而非第二級 (2錯)；企業須繳納利得稅而非薪俸稅 (3錯)。" },
            // ... (Other 2022 questions) ...

            // 2021 Questions
            { id: 202101, year: "2021", topic: "Business Environment", question: "下列哪項有關世界貿易組織的陳述是正確的？\n(1) 它執行成員之間的國際貿易規則。\n(2) 它協助發展中國家增加貿易機會。\n(3) 它消除成員之間的貿易障礙。", options: ["只有 (1)", "只有 (1) 及 (2)", "只有 (2) 及 (3)", "(1)、(2) 及 (3)"], answer: 1, explanation: "世貿組織負責執行貿易協定及協助發展中國家 (1, 2對)；其目標是「減少」而非完全「消除」所有障礙 (3略有保留，但在DSE常規中，消除所有障礙通常被視為過於絕對，且選項B為最佳答案)。" },
            // ... (Other 2021 questions would go here) ...

            // 2020 Questions
            { id: 202001, year: "2020", topic: "Forms of Business Ownership", question: "何名與徐思計劃共同創立及經營一家餐館，這餐館不會因任何一方的退出而結業。他們應採用哪一種企業擁有權類型？", options: ["合夥", "公營公司", "私人有限公司", "上市公司"], answer: 2, explanation: "「不會因任何一方退出而結業」指企業具有延續性 (Perpetual Succession)。私人有限公司是獨立法人，符合此特點，且適合兩人共同經營。" }
            // ... (Other 2020 questions would go here) ...
        ];

        // 這是全域變數，會混合本地題目 + 雲端題目
        window.BAFS_DB = [...REAL_QUESTIONS];
        let CLOUD_QUESTIONS_CACHE = [];

        // === 2. GitHub 題庫連結 (2012-2019) ===
        // 請將您的 QUESTIONS.js 檔案的 "Raw" 連結貼在這裡
        // 建議使用: https://your-username.github.io/your-repo/QUESTIONS.js
        const GITHUB_DATA_URL = ''; 

        // === 3. FIREBASE CONFIG 設定區 ===
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBt7EdhDqdpNQuh1jo6AmCNO3Vgso-c8pg",
            authDomain: "bafs-140c4.firebaseapp.com",
            projectId: "bafs-140c4",
            storageBucket: "bafs-140c4.firebasestorage.app",
            messagingSenderId: "859626093746",
            appId: "1:859626093746:web:8e0ffb9616bce754d0ddab"
        }; 

        const firebaseConfig = YOUR_FIREBASE_CONFIG || JSON.parse(new URLSearchParams(window.location.search).get('__firebase_config') || '{}');
        
        let db, auth, user;
        // Robust appId handling
        let appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || 'default-app-id');

        try {
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 監聽登入狀態
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    appLogic.updateAuthUI(u);
                    
                    if(u) {
                        // 登入後載入雲端數據
                        appLogic.loadCloudQuestions();
                        appLogic.loadCloudStats();
                        appLogic.loadExternalQuestions(); // Load GitHub Data
                    } else {
                         // 強制登入 (匿名)
                         signInAnonymously(auth).catch(e => {
                             console.error("Anonymous auth failed", e);
                             alert("自動登入失敗，請檢查網絡");
                         });
                    }
                });
            } else {
                console.warn("No Firebase Config found. App running in static mode.");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // === 4. APP LOGIC ===
        class BAFSApp {
            constructor() {
                this.currentQuestions = [];
                this.currentIndex = 0;
                this.score = 0;
                this.mode = 'practice';
                this.userAnswers = {};
                this.timerInterval = null;
                this.timeRemaining = 75 * 60;
                this.selectedYear = null;
                this.mistakes = JSON.parse(localStorage.getItem('bafs_mistakes')) || [];
                this.stats = JSON.parse(localStorage.getItem('bafs_stats')) || { total: 0, correct: 0 };
                this.currentEditingId = null; // null = add mode, string = edit mode ID
                
                this.init();
            }

            init() {
                // 初次渲染 (只顯示靜態題目)
                this.renderYears();
                this.updateStatsUI();
            }

            updateAuthUI(user) {
                const userDisplay = document.getElementById('user-display');
                if (user) {
                    userDisplay.classList.remove('hidden');
                    document.getElementById('username-span').innerText = '訪客 ' + user.uid.substring(0, 5);
                } else {
                    userDisplay.classList.add('hidden');
                }
            }

            // --- Load External Questions from GitHub ---
            async loadExternalQuestions() {
                if (!GITHUB_DATA_URL) return;

                const loadingBar = document.getElementById('external-loading-bar');
                if(loadingBar) loadingBar.classList.remove('hidden');

                try {
                    const response = await fetch(GITHUB_DATA_URL);
                    const text = await response.text();
                    
                    // Attempt to parse text. It might be pure JSON or JS with "window.EXTERNAL_QUESTIONS ="
                    let jsonData;
                    if (text.trim().startsWith('[')) {
                        jsonData = JSON.parse(text);
                    } else {
                        // Very basic extraction if it's a JS file
                        const jsonStr = text.substring(text.indexOf('['), text.lastIndexOf(']') + 1);
                        jsonData = JSON.parse(jsonStr);
                    }

                    if (Array.isArray(jsonData)) {
                        // Merge uniquely
                        const currentIds = new Set(window.BAFS_DB.map(q => q.id));
                        const newQs = jsonData.filter(q => !currentIds.has(q.id));
                        
                        window.BAFS_DB = [...window.BAFS_DB, ...newQs];
                        
                        // Sort by year desc
                        window.BAFS_DB.sort((a, b) => b.year.toString().localeCompare(a.year.toString()) || a.id - b.id);

                        this.renderYears();
                        this.showToast(`成功載入 ${newQs.length} 條額外題目！`);
                    }
                } catch (e) {
                    console.error("Failed to load GitHub questions:", e);
                    this.showToast("無法載入外部題庫 (GitHub)");
                } finally {
                    if(loadingBar) loadingBar.classList.add('hidden');
                }
            }

            // --- Database Sync & Management ---
            async loadCloudQuestions() {
                if (!db) return;
                try {
                    const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                    const snapshot = await getDocs(qRef);
                    
                    CLOUD_QUESTIONS_CACHE = [];
                    snapshot.forEach(doc => {
                        // Tag cloud questions with isCloud: true and their Firestore doc id
                        CLOUD_QUESTIONS_CACHE.push({ ...doc.data(), id: doc.id, isCloud: true });
                    });

                    // Merge static + cloud + external(already merged potentially)
                    // We need a strategy to not duplicate. 
                    // BAFS_DB is dynamic. Let's just append cloud ones that are not there.
                    const currentIds = new Set(window.BAFS_DB.map(q => q.id));
                    const newQs = CLOUD_QUESTIONS_CACHE.filter(q => !currentIds.has(q.id));
                    
                    window.BAFS_DB = [...window.BAFS_DB, ...newQs];
                    
                    this.renderYears();
                } catch (e) {
                    console.error("Failed to load cloud questions:", e);
                }
            }
            
            // --- Navigation ---
            router(viewId) {
                document.querySelectorAll('.hidden-page, #home-view').forEach(el => {
                    if(el.id !== 'mobile-menu') el.style.display = 'none';
                });
                
                const target = document.getElementById(viewId + '-view');
                if (target) {
                    target.style.display = 'block';
                    window.scrollTo(0, 0);
                    
                    if(viewId === 'mistakes') this.renderMistakes();
                    if(viewId === 'leaderboard') this.loadLeaderboard();
                }
            }

            toggleDarkMode() {
                document.documentElement.classList.toggle('dark');
            }

            showToast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.style.transform = 'translate(-50%, 0)';
                setTimeout(() => {
                    t.style.transform = 'translate(-50%, 5rem)';
                }, 3000);
            }

            // --- Home & Selection ---
            renderYears() {
                const grid = document.getElementById('year-grid');
                grid.innerHTML = '';
                
                // Sort years desc
                const years = [...new Set(window.BAFS_DB.map(q => q.year))].sort((a,b) => {
                    // Handle "Sample Paper" etc. which are strings
                    if (isNaN(a) && !isNaN(b)) return -1;
                    if (!isNaN(a) && isNaN(b)) return 1;
                    if (isNaN(a) && isNaN(b)) return a.localeCompare(b);
                    return b - a;
                });
                
                if (years.length === 0) {
                    grid.innerHTML = '<div class="col-span-3 text-center text-gray-500">正在載入題庫...</div>';
                    return;
                }

                years.forEach(year => {
                    const btn = document.createElement('button');
                    btn.className = "cartoon-card p-4 hover:bg-brand-blue hover:text-white font-bold text-lg transition duration-200 flex flex-col items-center justify-center h-24 dark:text-gray-900";
                    btn.innerHTML = `
                        <span>${year}</span>
                        <span class="text-xs font-normal opacity-70 mt-1">練習</span>
                    `;
                    btn.onclick = () => this.openModeModal(year);
                    grid.appendChild(btn);
                });
            }

            openModeModal(year) {
                this.selectedYear = year;
                document.getElementById('modal-year-title').innerText = `${year} MC Paper 1`;
                document.getElementById('mode-modal').classList.remove('hidden');
            }

            startRandomMock() {
                if (window.BAFS_DB.length === 0) {
                    this.showToast("題庫是空的！");
                    return;
                }
                const shuffled = [...window.BAFS_DB].sort(() => 0.5 - Math.random());
                this.currentQuestions = shuffled.slice(0, 24); 
                this.selectedYear = "隨機模擬卷";
                this.openModeModal("隨機模擬卷"); 
            }

            startMiniQuiz() {
                if (window.BAFS_DB.length === 0) {
                    this.showToast("題庫是空的！");
                    return;
                }
                const shuffled = [...window.BAFS_DB].sort(() => 0.5 - Math.random());
                this.currentQuestions = shuffled.slice(0, 20);
                this.selectedYear = "極速小測";
                this.openModeModal("極速小測");
            }

            // --- Quiz Logic ---
            startQuiz(mode, isSearch = false) {
                document.getElementById('mode-modal').classList.add('hidden');
                this.mode = mode;
                
                if (!isSearch && this.selectedYear !== "隨機模擬卷" && this.selectedYear !== "極速小測") {
                    this.currentQuestions = window.BAFS_DB.filter(q => q.year === this.selectedYear);
                }

                if (this.currentQuestions.length === 0) {
                    this.showToast("此年份暫無題目");
                    return;
                }

                this.currentIndex = 0;
                this.score = 0;
                this.userAnswers = {};
                this.router('quiz');

                document.getElementById('quiz-title').innerText = this.selectedYear;
                document.getElementById('quiz-mode-label').innerText = mode === 'exam' ? 'MOCK EXAM MODE' : 'PRACTICE MODE';
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('btn-submit').classList.add('hidden');

                const timerDisplay = document.getElementById('timer-display');
                if (mode === 'exam') {
                    if (this.selectedYear.includes("模擬卷")) {
                        this.timeRemaining = 30 * 60;
                    } else if (this.selectedYear.includes("小測")) {
                        this.timeRemaining = 20 * 60;
                    } else {
                        this.timeRemaining = 30 * 60;
                    }
                    timerDisplay.classList.remove('hidden');
                    this.startTimer();
                } else {
                    timerDisplay.classList.add('hidden');
                    clearInterval(this.timerInterval);
                }

                this.renderQuestion();
            }

            startTimer() {
                clearInterval(this.timerInterval);
                const display = document.getElementById('timer-display');
                
                this.timerInterval = setInterval(() => {
                    this.timeRemaining--;
                    const m = Math.floor(this.timeRemaining / 60);
                    const s = this.timeRemaining % 60;
                    display.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                    
                    if (this.timeRemaining <= 0) {
                        this.endQuizEarly();
                    }
                }, 1000);
            }

            renderQuestion() {
                const q = this.currentQuestions[this.currentIndex];
                const total = this.currentQuestions.length;
                
                document.getElementById('q-number').innerText = `${this.currentIndex + 1}/${total}`;
                // Set the question source badge text (e.g., 2021 Q1)
                const qSourceText = q.id ? `${q.year} Q${String(q.id).slice(-2).replace(/^0+/, '')}` : `${q.year}`;
                document.getElementById('q-source').innerText = qSourceText;
                
                document.getElementById('q-text').innerText = q.question;
                
                const pct = ((this.currentIndex) / total) * 100;
                document.getElementById('quiz-progress').style.width = `${pct}%`;

                const optsContainer = document.getElementById('q-options');
                optsContainer.innerHTML = '';
                
                q.options.forEach((opt, idx) => {
                    const isSelected = this.userAnswers[q.id || this.currentIndex] === idx; 
                    const qId = q.id || this.currentIndex;

                    const label = document.createElement('label');
                    label.className = "cursor-pointer block relative group";
                    label.innerHTML = `
                        <input type="radio" name="opt" class="hidden option-input" value="${idx}" ${isSelected ? 'checked' : ''} onchange="app.selectOption(${idx})">
                        <div class="p-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 hover:border-black dark:hover:border-white transition flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full border-2 border-gray-400 flex items-center justify-center font-bold text-gray-500 group-hover:bg-black group-hover:text-white transition-colors">
                                ${String.fromCharCode(65 + idx)}
                            </span>
                            <span class="text-lg">${opt}</span>
                        </div>
                    `;
                    optsContainer.appendChild(label);
                });

                document.getElementById('explanation-box').classList.add('hidden');
                
                document.getElementById('btn-prev').disabled = this.currentIndex === 0;
                
                if (this.currentIndex === total - 1) {
                    document.getElementById('btn-next').classList.add('hidden');
                    document.getElementById('btn-submit').classList.remove('hidden');
                } else {
                    document.getElementById('btn-next').classList.remove('hidden');
                    document.getElementById('btn-submit').classList.add('hidden');
                }

                const qId = q.id || this.currentIndex;
                if (this.mode === 'practice' && this.userAnswers[qId] !== undefined) {
                    this.showFeedback(q, this.userAnswers[qId]);
                }
            }

            selectOption(idx) {
                const q = this.currentQuestions[this.currentIndex];
                const qId = q.id || this.currentIndex;
                
                if (this.mode === 'practice' && this.userAnswers[qId] !== undefined) return;
                
                this.userAnswers[qId] = idx;

                if (this.mode === 'practice') {
                    this.showFeedback(q, idx);
                }
            }

            showFeedback(q, selectedIdx) {
                const isCorrect = selectedIdx === q.answer;
                const opts = document.querySelectorAll('.option-input + div');
                
                opts[selectedIdx].classList.remove('border-gray-300', 'border-black');
                opts[selectedIdx].classList.add(isCorrect ? 'bg-green-100' : 'bg-red-100', isCorrect ? 'border-green-500' : 'border-red-500', 'text-black');
                
                if (!isCorrect) {
                    opts[q.answer].classList.add('bg-green-100', 'border-green-500', 'text-black');
                    this.addMistake(q);
                }

                const expBox = document.getElementById('explanation-box');
                document.getElementById('explanation-text').innerText = q.explanation;
                expBox.classList.remove('hidden');

                document.querySelectorAll('input[type="radio"]').forEach(el => el.disabled = true);
            }

            nextQuestion() {
                if (this.currentIndex < this.currentQuestions.length - 1) {
                    this.currentIndex++;
                    this.renderQuestion();
                }
            }

            prevQuestion() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.renderQuestion();
                }
            }

            addMistake(question) {
                const qId = question.id || question.question; 
                if (!this.mistakes.find(m => (m.id || m.question) === qId)) {
                    this.mistakes.push(question);
                    localStorage.setItem('bafs_mistakes', JSON.stringify(this.mistakes));
                }
            }

            endQuizEarly() {
                if(confirm("確定結束練習並查看成績？")) {
                    this.submitQuiz();
                }
            }

            submitQuiz() {
                clearInterval(this.timerInterval);
                
                let correctCount = 0;
                this.currentQuestions.forEach(q => {
                    const key = q.id || this.currentQuestions.indexOf(q);
                    const userAns = this.userAnswers[q.id];
                    
                    if (userAns === q.answer) {
                        correctCount++;
                    } else if (this.mode === 'exam' && userAns !== undefined) {
                        this.addMistake(q);
                    }
                });

                this.score = correctCount;
                const total = this.currentQuestions.length;
                
                this.stats.total += total;
                this.stats.correct += correctCount;
                localStorage.setItem('bafs_stats', JSON.stringify(this.stats));
                this.updateStatsUI();

                document.getElementById('result-subtitle').innerText = `${this.selectedYear} • ${this.mode === 'exam' ? '模擬考' : '練習'}`;
                document.getElementById('result-score').innerText = this.score;
                document.getElementById('result-total').innerText = total;
                document.getElementById('result-correct').innerText = correctCount;
                document.getElementById('result-wrong').innerText = total - correctCount;

                this.router('result');
                
                if (correctCount / total > 0.5) {
                    this.fireConfetti();
                }

                // 自動上傳分數
                setTimeout(() => {
                    if (user) {
                        this.saveToLeaderboard(true);
                    } else {
                        signInAnonymously(auth).then(() => {
                            this.saveToLeaderboard(true);
                        }).catch(e => console.error("Auto login failed during submit", e));
                    }
                }, 500);
            }

            fireConfetti() {
                for(let i=0; i<50; i++) {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.backgroundColor = ['#FFD93D', '#4D96FF', '#FF6B6B'][Math.floor(Math.random()*3)];
                    c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 4000);
                }
            }

            renderMistakes() {
                const list = document.getElementById('mistakes-list');
                const emptyMsg = document.getElementById('no-mistakes-msg');
                list.innerHTML = '';

                if (this.mistakes.length === 0) {
                    emptyMsg.classList.remove('hidden');
                    return;
                }
                emptyMsg.classList.add('hidden');

                this.mistakes.forEach(q => {
                    const div = document.createElement('div');
                    div.className = "cartoon-card p-6 bg-white dark:bg-gray-800 relative";
                    div.innerHTML = `
                        <div class="absolute top-4 right-4 text-xs font-bold text-gray-400">${q.year}</div>
                        <h4 class="font-bold text-lg mb-3 pr-8">${q.question}</h4>
                        <div class="space-y-2 mb-4">
                            ${q.options.map((opt, i) => `
                                <div class="px-3 py-2 rounded border ${i === q.answer ? 'bg-green-100 border-green-500 text-black' : 'border-gray-200 dark:border-gray-600'}">
                                    ${String.fromCharCode(65+i)}. ${opt}
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-sm bg-blue-50 dark:bg-blue-900/20 p-3 rounded text-brand-blue dark:text-blue-300">
                            <strong>詳解：</strong> ${q.explanation}
                        </div>
                        <button class="mt-4 text-xs text-red-500 underline font-bold" onclick="app.removeMistake('${q.id}')">移除此題</button>
                    `;
                    list.appendChild(div);
                });
            }

            removeMistake(id) {
                this.mistakes = this.mistakes.filter(m => m.id != id); 
                localStorage.setItem('bafs_mistakes', JSON.stringify(this.mistakes));
                this.renderMistakes();
                this.updateStatsUI();
            }

            clearMistakes() {
                if(confirm("確定清除所有錯題？")) {
                    this.mistakes = [];
                    localStorage.setItem('bafs_mistakes', JSON.stringify([]));
                    this.renderMistakes();
                    this.updateStatsUI();
                }
            }

            updateStatsUI() {
                document.getElementById('stat-total-done').innerText = this.stats.total;
                const acc = this.stats.total === 0 ? 0 : Math.round((this.stats.correct / this.stats.total) * 100);
                document.getElementById('stat-accuracy').innerText = acc + '%';
                document.getElementById('stat-mistakes').innerText = this.mistakes.length;
            }

            shareResult() {
                const text = `我剛在 BAFS 狀元工廠 (${this.selectedYear}) 拿到 ${this.score}/${this.currentQuestions.length} 分！快來挑戰！`;
                if (navigator.share) {
                    navigator.share({ title: 'BAFS 成績', text: text, url: window.location.href });
                } else {
                    navigator.clipboard.writeText(text);
                    this.showToast("成績已複製到剪貼簿！");
                }
            }

            // Modified to support Auto-Upload
            async saveToLeaderboard(isAuto = false) {
                if (!user) {
                    // Anonymous login handles this
                    return;
                }
                
                let nickname;
                if (isAuto) {
                    // 自動模式：直接產生暱稱，不詢問
                    nickname = "訪客 " + user.uid.substring(0, 5);
                    this.showToast("正在自動上傳成績...");
                } else {
                    nickname = prompt("請輸入你在龍虎榜上的暱稱：", "訪客 " + user.uid.substring(0, 5));
                }
                
                if (!nickname) return;

                const acc = Math.round((this.score / this.currentQuestions.length) * 100);

                try {
                    const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                    await addDoc(scoresRef, {
                        nickname: nickname,
                        score: this.score,
                        accuracy: acc,
                        year: this.selectedYear,
                        timestamp: serverTimestamp()
                    });
                    
                    if (isAuto) {
                        document.getElementById('auto-upload-msg').classList.remove('hidden');
                        this.showToast("✅ 成績已自動上傳至龍虎榜！");
                    } else {
                        this.showToast("上傳成功！");
                        setTimeout(() => this.router('leaderboard'), 1000);
                    }
                } catch (e) {
                    console.error(e);
                    if (!isAuto) this.showToast("上傳失敗，請檢查資料庫規則。");
                }
            }

            async loadLeaderboard() {
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">載入中...</td></tr>';
                
                try {
                    const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                    const q = query(scoresRef); 
                    const querySnapshot = await getDocs(q);
                    
                    let data = [];
                    querySnapshot.forEach((doc) => {
                        data.push(doc.data());
                    });

                    data.sort((a, b) => b.score - a.score);
                    data = data.slice(0, 50);

                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">暫無數據，快來搶第一！</td></tr>';
                        return;
                    }

                    data.forEach((entry, idx) => {
                        let rankClass = "";
                        let icon = "";
                        if (idx === 0) { rankClass = "text-brand-yellow font-bold text-xl"; icon = "👑"; }
                        else if (idx === 1) { rankClass = "text-gray-400 font-bold text-lg"; icon = "🥈"; }
                        else if (idx === 2) { rankClass = "text-orange-400 font-bold text-lg"; icon = "🥉"; }

                        const row = `
                            <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="p-4 ${rankClass}">${icon} ${idx + 1}</td>
                                <td class="p-4 font-bold">${entry.nickname}</td>
                                <td class="p-4 text-sm text-gray-500 hidden md:table-cell">${entry.year}</td>
                                <td class="p-4 text-right font-mono font-bold text-brand-blue">${entry.score}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });

                } catch (e) {
                    console.error(e);
                    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">
                        無法載入數據<br>
                        <span class="text-xs text-gray-500">${e.message}</span><br>
                        <span class="text-xs">請檢查 Firestore 規則是否設為 Test Mode</span>
                    </td></tr>`;
                }
            }

            async loadCloudStats() {
                if(!user) return;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', 'main');
                    // Future sync logic
                } catch(e) { }
            }
        }

        window.app = new BAFSApp();
        window.router = (view) => app.router(view);

    </script>
</body>
</html>


