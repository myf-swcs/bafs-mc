<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAFS ç‹€å…ƒå·¥å»  (MC Master)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Comic Neue for Cartoon feel -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <!-- Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'cartoon': ['"Comic Neue"', 'cursive'],
                        'body': ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        'brand-yellow': '#FFD93D',
                        'brand-blue': '#4D96FF',
                        'brand-green': '#6BCB77',
                        'brand-red': '#FF6B6B',
                        'brand-dark': '#2D2D2D',
                    },
                    boxShadow: {
                        'cartoon': '4px 4px 0px 0px #000000',
                        'cartoon-sm': '2px 2px 0px 0px #000000',
                        'cartoon-hover': '6px 6px 0px 0px #000000',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
        }
        
        .cartoon-font {
            font-family: 'Comic Neue', cursive;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-left: 2px solid black;
        }
        ::-webkit-scrollbar-thumb {
            background: #4D96FF;
            border: 2px solid black;
            border-radius: 10px;
        }

        /* Animations */
        @keyframes bounce-small {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-bounce-hover:hover {
            animation: bounce-small 0.5s infinite;
        }

        .cartoon-card {
            border: 3px solid black;
            border-radius: 1rem;
            box-shadow: 4px 4px 0px 0px #000000;
            transition: all 0.2s ease;
            background-color: white;
        }

        .dark .cartoon-card {
            background-color: #374151; /* gray-700 */
            box-shadow: 4px 4px 0px 0px #ffffff;
            border-color: white;
        }

        .cartoon-btn {
            border: 2px solid black;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 3px 3px 0px 0px #000000;
            transition: all 0.1s;
        }
        .cartoon-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px 0px #000000;
        }

        .dark .cartoon-btn {
            box-shadow: 3px 3px 0px 0px #ffffff;
            border-color: white;
        }
        
        /* Checkbox styling */
        .option-input:checked + div {
            background-color: #4D96FF;
            color: white;
            border-color: black;
            box-shadow: inset 2px 2px 0px 0px rgba(0,0,0,0.2);
        }

        .hidden-page {
            display: none;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 9999;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
        
        /* Pre-formatted text for questions to preserve newlines */
        .question-text {
            white-space: pre-line;
        }
    </style>
</head>
<body class="bg-yellow-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white dark:bg-gray-800 border-b-4 border-black dark:border-white px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2 cursor-pointer" onclick="app.router('home')">
            <i class="fa-solid fa-graduation-cap text-3xl text-brand-blue dark:text-brand-yellow drop-shadow-[2px_2px_0_rgba(0,0,0,1)]"></i>
            <h1 class="text-2xl font-bold cartoon-font tracking-wider">BAFS <span class="text-brand-blue dark:text-brand-yellow">MC</span> å·¥å» </h1>
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="app.toggleDarkMode()" class="p-2 rounded-full border-2 border-black dark:border-white hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <i class="fa-solid fa-moon dark:hidden"></i>
                <i class="fa-solid fa-sun hidden dark:block text-brand-yellow"></i>
            </button>
            
            <!-- Auth Buttons -->
            <div id="auth-section" class="flex items-center gap-2">
                <!-- Logged Out State -->
                <button id="btn-login-nav" onclick="app.openAuthModal(false)" class="hidden cartoon-btn bg-brand-yellow px-4 py-1 rounded-lg text-sm hover:bg-yellow-300">
                    <i class="fa-solid fa-right-to-bracket mr-1"></i> ç™»å…¥
                </button>
                
                <!-- Logged In State -->
                <div id="user-display" class="hidden flex items-center gap-2 text-sm font-bold border-2 border-black dark:border-white px-3 py-1 rounded-full bg-brand-green text-white shadow-cartoon-sm">
                    <i class="fa-solid fa-user"></i> <span id="username-span">User</span>
                </div>
                <button id="btn-logout-nav" onclick="app.handleLogout()" class="hidden p-2 text-red-500 hover:text-red-700 font-bold" title="ç™»å‡º">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>

            <!-- Mobile Menu Button -->
            <button class="md:hidden cartoon-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden fixed inset-0 z-40 bg-black/90 flex flex-col items-center justify-center space-y-6 text-white text-2xl font-bold cartoon-font">
        <button class="absolute top-5 right-5 text-4xl" onclick="document.getElementById('mobile-menu').classList.add('hidden')">&times;</button>
        <a href="#" onclick="app.router('home'); document.getElementById('mobile-menu').classList.add('hidden')">ä¸»é </a>
        <a href="#" onclick="app.router('mistakes'); document.getElementById('mobile-menu').classList.add('hidden')">æˆ‘çš„éŒ¯é¡Œæœ¬</a>
        <a href="#" onclick="app.router('leaderboard'); document.getElementById('mobile-menu').classList.add('hidden')">é¾è™æ¦œ</a>
        <a href="#" onclick="app.router('admin'); document.getElementById('mobile-menu').classList.add('hidden')">ç®¡ç†å“¡å¾Œå°</a>
        <a href="#" onclick="app.openAuthModal(false); document.getElementById('mobile-menu').classList.add('hidden')" class="text-brand-yellow">ç™»å…¥ / è¨»å†Š</a>
    </div>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-4 max-w-4xl relative">
        
        <!-- === HOME VIEW === -->
        <div id="home-view" class="space-y-8 animate-fade-in">
            <!-- Hero Section -->
            <div class="cartoon-card bg-brand-blue text-white p-6 md:p-10 text-center relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/20 rounded-full"></div>
                <div class="absolute top-20 -left-10 w-20 h-20 bg-brand-yellow/30 rounded-full"></div>
                <h2 class="text-3xl md:text-5xl font-bold mb-4 cartoon-font drop-shadow-[3px_3px_0_rgba(0,0,0,1)]">BAFS 5** ç”Ÿæˆå™¨</h2>
                <p class="text-lg md:text-xl font-medium mb-6">æ­·å±†è©¦é¡Œ â€¢ å³æ™‚è©³è§£ â€¢ éŒ¯é¡Œé‡æº« â€¢ é¾è™æ¦œ</p>
                <div class="flex flex-wrap justify-center gap-4">
                    <button onclick="app.startRandomMock()" class="cartoon-btn bg-brand-yellow text-black px-6 py-3 rounded-xl text-lg hover:bg-yellow-300">
                        <i class="fa-solid fa-shuffle mr-2"></i>éš¨æ©Ÿæ¨¡æ“¬å· (45é¡Œ)
                    </button>
                    <button onclick="app.router('mistakes')" class="cartoon-btn bg-brand-red text-white px-6 py-3 rounded-xl text-lg hover:bg-red-500">
                        <i class="fa-solid fa-book-skull mr-2"></i>é‡æº«éŒ¯é¡Œ
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="relative">
                <input type="text" id="search-input" placeholder="ğŸ” æœå°‹é¡Œç›®é—œéµå­— (ä¾‹å¦‚: æ¯”ç‡, prudence, limited company...)" 
                    class="w-full border-4 border-black dark:border-white rounded-2xl px-5 py-4 text-lg shadow-cartoon focus:outline-none focus:translate-x-1 focus:translate-y-1 focus:shadow-none transition dark:bg-gray-800 dark:text-white">
                <button onclick="app.handleSearch()" class="absolute right-3 top-3 cartoon-btn bg-brand-green text-white px-4 py-2 rounded-xl">æœå°‹</button>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="cartoon-card p-4 text-center bg-white dark:bg-gray-800">
                    <div class="text-3xl font-bold text-brand-blue" id="stat-total-done">0</div>
                    <div class="text-sm font-bold text-gray-500 dark:text-gray-300">å·²åšé¡Œæ•¸</div>
                </div>
                <div class="cartoon-card p-4 text-center bg-white dark:bg-gray-800">
                    <div class="text-3xl font-bold text-brand-green" id="stat-accuracy">0%</div>
                    <div class="text-sm font-bold text-gray-500 dark:text-gray-300">ç¸½æ­£ç¢ºç‡</div>
                </div>
                <div class="cartoon-card p-4 text-center bg-white dark:bg-gray-800">
                    <div class="text-3xl font-bold text-brand-red" id="stat-mistakes">0</div>
                    <div class="text-sm font-bold text-gray-500 dark:text-gray-300">å¾…æ”¹éŒ¯é¡Œ</div>
                </div>
                <div class="cartoon-card p-4 text-center bg-white dark:bg-gray-800 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700" onclick="app.router('leaderboard')">
                    <div class="text-3xl font-bold text-brand-yellow"><i class="fa-solid fa-trophy"></i></div>
                    <div class="text-sm font-bold text-gray-500 dark:text-gray-300">é¾è™æ¦œ</div>
                </div>
            </div>

            <!-- Year Selection -->
            <div>
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <span class="w-4 h-8 bg-brand-blue rounded-full block"></span>
                    å¹´ä»½ç·´ç¿’
                </h3>
                <div class="grid grid-cols-3 md:grid-cols-5 gap-4" id="year-grid">
                    <!-- JS will populate this -->
                    <div class="col-span-3 text-center py-8 text-gray-400">æ­£åœ¨è¼‰å…¥é¡Œåº«...</div>
                </div>
            </div>
        </div>

        <!-- === ADMIN VIEW (NEW) === -->
        <div id="admin-view" class="hidden-page">
            <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                <i class="fa-solid fa-database text-brand-blue"></i> é¡Œç›®ç®¡ç†å¾Œå°
            </h2>
            
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- Left Column: Manual Form -->
                <div class="cartoon-card p-6 bg-white dark:bg-gray-800 h-fit">
                    <h3 class="font-bold text-xl mb-4 border-b-2 border-black pb-2 flex justify-between items-center">
                        <span id="form-mode-title">å–®é¡Œæ–°å¢</span>
                        <button onclick="app.resetAdminForm()" class="text-xs bg-gray-200 text-black px-2 py-1 rounded hidden" id="btn-cancel-edit">å–æ¶ˆç·¨è¼¯</button>
                    </h3>
                    <form id="add-q-form" onsubmit="event.preventDefault(); app.handleQuestionSubmit();">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-bold mb-1">å¹´ä»½ (Year)</label>
                                <input type="text" id="admin-year" class="w-full border-2 border-black rounded p-2 bg-gray-50" placeholder="ä¾‹å¦‚: 2024" required>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">èª²é¡Œ (Topic)</label>
                                <select id="admin-topic" class="w-full border-2 border-black rounded p-2 bg-gray-50">
                                    <option>Accounting</option>
                                    <option>Management</option>
                                    <option>Personal Finance</option>
                                    <option>Business Environment</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">é¡Œç›® (Question)</label>
                                <textarea id="admin-q-text" class="w-full border-2 border-black rounded p-2 bg-gray-50 h-24" placeholder="è¼¸å…¥é¡Œç›®å…§å®¹..." required></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="admin-opt-0" class="border-2 border-gray-300 rounded p-2 text-sm" placeholder="é¸é … A" required>
                                <input type="text" id="admin-opt-1" class="border-2 border-gray-300 rounded p-2 text-sm" placeholder="é¸é … B" required>
                                <input type="text" id="admin-opt-2" class="border-2 border-gray-300 rounded p-2 text-sm" placeholder="é¸é … C" required>
                                <input type="text" id="admin-opt-3" class="border-2 border-gray-300 rounded p-2 text-sm" placeholder="é¸é … D" required>
                            </div>

                            <div>
                                <label class="block text-sm font-bold mb-1">æ­£ç¢ºç­”æ¡ˆ</label>
                                <div class="flex gap-4">
                                    <label><input type="radio" name="admin-ans" value="0" checked> A</label>
                                    <label><input type="radio" name="admin-ans" value="1"> B</label>
                                    <label><input type="radio" name="admin-ans" value="2"> C</label>
                                    <label><input type="radio" name="admin-ans" value="3"> D</label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold mb-1">è©³è§£ (Explanation)</label>
                                <textarea id="admin-expl" class="w-full border-2 border-black rounded p-2 bg-gray-50 h-20" placeholder="ç‚ºä»€éº¼é€™å€‹ç­”æ¡ˆæ˜¯å°çš„ï¼Ÿ" required></textarea>
                            </div>

                            <button type="submit" id="btn-submit-q" class="w-full cartoon-btn bg-brand-green text-white py-3 rounded hover:bg-green-600">
                                <i class="fa-solid fa-cloud-arrow-up mr-2"></i>ç™¼å¸ƒåˆ°é›²ç«¯é¡Œåº«
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Right Column: Bulk Import & List -->
                <div class="space-y-6">
                    <!-- NEW BULK IMPORT SECTION -->
                    <div class="cartoon-card p-6 bg-blue-50 dark:bg-blue-900/30 border-brand-blue">
                        <h3 class="font-bold text-xl mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-file-import text-brand-blue"></i> æ‰¹é‡åŒ¯å…¥ (JSON ä»£ç¢¼)
                        </h3>
                        <p class="text-xs text-gray-500 mb-3">è«‹å°‡ JSON æ ¼å¼çš„é¡Œç›®ä»£ç¢¼è²¼å…¥ä¸‹æ–¹ï¼Œæˆ–ä½¿ç”¨åœ–ç‰‡è¾¨è­˜ã€‚</p>
                        
                        <!-- File Input for OCR -->
                        <input type="file" id="ocr-file-input" class="hidden" accept="image/*" onchange="app.handleOCR(this)">
                        
                        <div class="flex gap-2 mb-2">
                            <button onclick="document.getElementById('ocr-file-input').click()" class="cartoon-btn bg-brand-yellow text-black px-3 py-1 rounded text-sm hover:bg-yellow-300 w-full flex items-center justify-center gap-2">
                                <i class="fa-solid fa-camera"></i> åœ–ç‰‡è¾¨è­˜åŒ¯å…¥ (OCR)
                            </button>
                        </div>
                        
                        <div id="ocr-status" class="text-xs font-bold text-brand-blue mb-2 hidden animate-pulse">
                            <i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨åˆ†æåœ–ç‰‡æ–‡å­—ï¼š<span id="ocr-progress">0%</span>
                        </div>

                        <textarea id="bulk-import-area" class="w-full border-2 border-brand-blue rounded p-2 text-xs font-mono h-32 bg-white dark:bg-gray-800" placeholder='[
  {
    "id": 202401,
    "year": "2024",
    "topic": "Accounting",
    "question": "é¡Œç›®å…§å®¹...",
    "options": ["A", "B", "C", "D"],
    "answer": 0,
    "explanation": "è§£é‡‹..."
  }
]'></textarea>
                        
                        <div class="flex gap-2 mt-3">
                            <button onclick="app.handleBulkImport()" class="cartoon-btn bg-brand-blue text-white px-4 py-2 rounded text-sm hover:bg-blue-600 flex-1">
                                <i class="fa-solid fa-upload mr-1"></i> é–‹å§‹åŒ¯å…¥
                            </button>
                            <button onclick="app.copyTemplate()" class="cartoon-btn bg-white dark:bg-gray-700 px-4 py-2 rounded text-sm hover:bg-gray-100">
                                <i class="fa-solid fa-copy mr-1"></i> è¤‡è£½ç¯„æœ¬
                            </button>
                        </div>
                    </div>

                    <!-- Manage List -->
                    <div class="cartoon-card p-6 bg-brand-yellow/20">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg">é›²ç«¯é¡Œåº«ç®¡ç†</h3>
                            <button onclick="app.testConnection()" class="text-xs bg-white border border-black px-2 py-1 rounded hover:bg-gray-100">
                                <i class="fa-solid fa-rotate"></i> é‡æ–°è¼‰å…¥
                            </button>
                        </div>
                        <p class="text-xs text-gray-600 mb-2">é€™è£¡åªæœƒé¡¯ç¤ºæ‚¨ä¸Šå‚³çš„é›²ç«¯é¡Œç›® (å¯ç·¨è¼¯)ã€‚</p>
                        <p id="firebase-status" class="text-xs font-bold text-red-500 mb-2">æœªé€£æ¥ Firebase</p>
                        
                        <!-- List Container -->
                        <div id="admin-q-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                            <div class="text-center text-gray-400 py-4">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === QUIZ VIEW === -->
        <div id="quiz-view" class="hidden-page pb-20">
            <!-- Quiz Header -->
            <div class="flex justify-between items-center mb-6 bg-white dark:bg-gray-800 p-4 border-b-4 border-black dark:border-white sticky top-16 z-30">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-widest" id="quiz-mode-label">PRACTICE MODE</span>
                    <h2 class="text-xl font-bold" id="quiz-title">2023 DSE</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div id="timer-display" class="text-xl font-mono font-bold bg-black text-brand-green px-3 py-1 rounded border-2 border-gray-500 hidden">
                        75:00
                    </div>
                    <button onclick="app.endQuizEarly()" class="text-sm underline text-red-500 font-bold">çµæŸç·´ç¿’</button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 h-4 border-2 border-black rounded-full mb-6 relative overflow-hidden">
                <div id="quiz-progress" class="bg-brand-blue h-full transition-all duration-300" style="width: 0%"></div>
            </div>

            <!-- Question Card -->
            <div class="cartoon-card p-6 md:p-8 mb-6 relative bg-white dark:bg-gray-800">
                <div class="absolute -top-3 -left-3 bg-brand-yellow border-2 border-black px-3 py-1 font-bold rounded-lg shadow-sm">
                    Q<span id="q-number">1</span>
                </div>
                
                <div class="mt-4 mb-6 text-lg md:text-xl font-medium leading-relaxed question-text" id="q-text">
                    Loading question...
                </div>

                <!-- Options -->
                <div class="space-y-3" id="q-options">
                    <!-- Options injected by JS -->
                </div>

                <!-- Explanation Box (Hidden initially) -->
                <div id="explanation-box" class="hidden mt-6 p-4 bg-blue-50 dark:bg-blue-900/30 border-l-4 border-brand-blue rounded-r-lg animate-fade-in">
                    <h4 class="font-bold text-brand-blue mb-1"><i class="fa-solid fa-lightbulb mr-2"></i>è©³è§£ï¼š</h4>
                    <p class="text-sm md:text-base text-gray-700 dark:text-gray-300" id="explanation-text"></p>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex justify-between items-center">
                <button id="btn-prev" onclick="app.prevQuestion()" class="cartoon-btn bg-gray-200 dark:bg-gray-700 px-6 py-3 rounded-xl disabled:opacity-50">
                    <i class="fa-solid fa-arrow-left"></i> ä¸Šä¸€é¡Œ
                </button>
                
                <button id="btn-next" onclick="app.nextQuestion()" class="cartoon-btn bg-brand-blue text-white px-8 py-3 rounded-xl shadow-cartoon hover:bg-blue-600 hidden">
                    ä¸‹ä¸€é¡Œ <i class="fa-solid fa-arrow-right"></i>
                </button>
                
                <button id="btn-submit" onclick="app.submitQuiz()" class="cartoon-btn bg-brand-green text-white px-8 py-3 rounded-xl shadow-cartoon hover:bg-green-600 hidden">
                    æäº¤è©¦å· <i class="fa-solid fa-check"></i>
                </button>
            </div>
        </div>

        <!-- === RESULT VIEW === -->
        <div id="result-view" class="hidden-page text-center pt-10">
            <h2 class="text-4xl font-bold mb-2 cartoon-font">æˆç¸¾å–®</h2>
            <p class="text-gray-500 mb-8" id="result-subtitle">2023 DSE â€¢ Practice Mode</p>

            <div class="cartoon-card p-8 bg-white dark:bg-gray-800 mb-8 inline-block w-full max-w-md">
                <div class="flex justify-center mb-6">
                    <div class="relative w-40 h-40 flex items-center justify-center rounded-full border-8 border-brand-blue" id="score-circle">
                        <div class="text-center">
                            <div class="text-4xl font-bold" id="result-score">40</div>
                            <div class="text-sm text-gray-500">/ <span id="result-total">45</span></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-lg border-2 border-green-200 dark:border-green-800">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="result-correct">0</div>
                        <div class="text-xs uppercase font-bold text-green-800 dark:text-green-200">æ­£ç¢º</div>
                    </div>
                    <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-lg border-2 border-red-200 dark:border-red-800">
                        <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="result-wrong">0</div>
                        <div class="text-xs uppercase font-bold text-red-800 dark:text-red-200">éŒ¯èª¤</div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <div id="auto-upload-msg" class="text-sm text-green-600 font-bold hidden mb-2">
                        <i class="fa-solid fa-check"></i> æˆç¸¾å·²è‡ªå‹•ä¸Šå‚³è‡³é¾è™æ¦œ
                    </div>
                    <!-- éš±è—æ‰‹å‹•ä¸Šå‚³æŒ‰éˆ•ï¼Œæ”¹ç‚ºè‡ªå‹• -->
                    <button onclick="app.shareResult()" class="cartoon-btn bg-gray-100 dark:bg-gray-700 dark:text-white w-full py-3 rounded-xl font-bold hover:bg-gray-200">
                        <i class="fa-solid fa-share-nodes mr-2"></i>åˆ†äº«æˆç¸¾
                    </button>
                </div>
            </div>

            <div class="flex justify-center gap-4">
                <button onclick="app.router('home')" class="cartoon-btn bg-white dark:bg-gray-700 px-6 py-3 rounded-xl">å›åˆ°ä¸»é </button>
                <button onclick="app.router('mistakes')" class="cartoon-btn bg-brand-red text-white px-6 py-3 rounded-xl">æŸ¥çœ‹éŒ¯é¡Œ</button>
            </div>
        </div>

        <!-- === MISTAKES VIEW === -->
        <div id="mistakes-view" class="hidden-page">
            <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                <i class="fa-solid fa-book-skull text-brand-red"></i> æˆ‘çš„éŒ¯é¡Œæœ¬
                <button onclick="app.clearMistakes()" class="text-sm bg-red-100 text-red-600 px-3 py-1 rounded-full border border-red-300 hover:bg-red-200 ml-auto">
                    æ¸…é™¤æ‰€æœ‰
                </button>
            </h2>
            <div id="mistakes-list" class="space-y-6">
                <!-- Injected via JS -->
            </div>
            <div id="no-mistakes-msg" class="text-center py-20 hidden">
                <i class="fa-solid fa-check-circle text-6xl text-green-300 mb-4"></i>
                <p class="text-xl font-bold text-gray-500">å¤ªå¼·äº†ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œã€‚</p>
                <button onclick="app.router('home')" class="mt-4 cartoon-btn bg-brand-blue text-white px-6 py-2 rounded-lg">å»ç·´ç¿’</button>
            </div>
        </div>

        <!-- === LEADERBOARD VIEW === -->
        <div id="leaderboard-view" class="hidden-page">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold cartoon-font bg-brand-yellow inline-block px-6 py-2 border-4 border-black rotate-[-2deg] shadow-cartoon">BAFS é¾è™æ¦œ</h2>
                <p class="mt-4 text-gray-500">Top 50 Legends</p>
            </div>

            <div class="cartoon-card overflow-hidden bg-white dark:bg-gray-800">
                <table class="w-full text-left">
                    <thead class="bg-black text-white">
                        <tr>
                            <th class="p-4">æ’å</th>
                            <th class="p-4">ç‹€å…ƒ</th>
                            <th class="p-4 hidden md:table-cell">å¹´ä»½/æ¨¡å¼</th>
                            <th class="p-4 text-right">åˆ†æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- JS injected -->
                    </tbody>
                </table>
            </div>
            <button onclick="app.router('home')" class="mt-8 cartoon-btn bg-white dark:bg-gray-700 w-full py-3 rounded-xl">è¿”å›</button>
        </div>

    </main>

    <!-- Footer with Admin Entry -->
    <footer class="text-center py-8 text-gray-400 text-xs mt-auto">
        <p>BAFS MC Master Â© 2024</p>
        <button onclick="app.router('admin')" class="mt-2 p-2 hover:text-gray-600 dark:hover:text-gray-200 transition">
            <i class="fa-solid fa-lock"></i>
        </button>
    </footer>

    <!-- Modal for Mode Selection -->
    <div id="mode-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl p-6 border-4 border-black shadow-[8px_8px_0_0_#fff]">
            <h3 class="text-2xl font-bold mb-2">é¸æ“‡æ¨¡å¼</h3>
            <p class="text-gray-500 mb-6" id="modal-year-title">2023 Year</p>
            
            <div class="space-y-4">
                <button onclick="app.startQuiz('practice')" class="w-full cartoon-card p-4 hover:bg-green-50 dark:hover:bg-green-900/20 flex items-center gap-4 group">
                    <div class="bg-brand-green text-white w-12 h-12 rounded-full flex items-center justify-center border-2 border-black group-hover:scale-110 transition">
                        <i class="fa-solid fa-dumbbell"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-lg">ç·´ç¿’æ¨¡å¼</div>
                        <div class="text-xs text-gray-500">å³æ™‚ç­”æ¡ˆ â€¢ ç„¡è¨ˆæ™‚ â€¢ è¼•é¬†åš</div>
                    </div>
                </button>

                <button onclick="app.startQuiz('exam')" class="w-full cartoon-card p-4 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-4 group">
                    <div class="bg-brand-red text-white w-12 h-12 rounded-full flex items-center justify-center border-2 border-black group-hover:scale-110 transition">
                        <i class="fa-solid fa-stopwatch"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-bold text-lg">æ¨¡æ“¬è€ƒæ¨¡å¼</div>
                        <div class="text-xs text-gray-500">75åˆ†é˜å€’æ•¸ â€¢ æœ€å¾Œå°å· â€¢ çœŸå¯¦é«”é©—</div>
                    </div>
                </button>
            </div>
            
            <button onclick="document.getElementById('mode-modal').classList.add('hidden')" class="mt-6 w-full py-3 text-gray-500 font-bold hover:text-black">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- AUTH MODAL (NEW) -->
    <div id="auth-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 border-4 border-black shadow-[8px_8px_0_0_#fff]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold" id="auth-title">ç™»å…¥å¸³è™Ÿ</h3>
                <!-- Close button hidden by default, shown if optional -->
                <button id="auth-close-btn" onclick="document.getElementById('auth-modal').classList.add('hidden')" class="text-gray-400 hover:text-black dark:hover:text-white hidden">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="auth-form" onsubmit="event.preventDefault(); app.handleAuthSubmit();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">é›»å­éƒµä»¶</label>
                        <input type="email" id="auth-email" class="w-full border-2 border-black rounded p-2 bg-gray-50" placeholder="student@example.com" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">å¯†ç¢¼</label>
                        <input type="password" id="auth-password" class="w-full border-2 border-black rounded p-2 bg-gray-50" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">
                    </div>
                    
                    <button type="submit" class="w-full cartoon-btn bg-brand-blue text-white py-3 rounded-xl hover:bg-blue-600 mt-2">
                        <span id="auth-submit-text">ç«‹å³ç™»å…¥</span>
                    </button>
                </div>
            </form>

            <div class="mt-4 text-center text-sm">
                <p id="auth-toggle-text">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <button onclick="app.toggleAuthMode()" class="text-brand-blue font-bold underline">å…è²»è¨»å†Š</button></p>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full shadow-lg translate-y-20 transition-transform duration-300 z-50 flex items-center gap-2">
        <i class="fa-solid fa-info-circle text-brand-yellow"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === 1. éœæ…‹é¡Œåº«è³‡æ–™åº« (æœ¬åœ°å‚™ä»½) ===
        // æˆ‘å€‘å°‡ 2024 çš„é¡Œç›®ä¿ç•™åœ¨æœ¬åœ°ï¼Œä½œç‚ºé›¢ç·šå‚™ç”¨
        const REAL_QUESTIONS = [
            {
                id: 202401, year: "2024", topic: "Business Environment",
                question: "ä¸‹åˆ—å“ªé …æ˜¯å•†ç•Œå°é¦™æ¸¯ç¶“æ¿Ÿçš„è²¢ç»ï¼Ÿ\n(1) éŠ·å”®è²¨å“èˆ‡æœå‹™è‡³æµ·å¤–ä»¥è³ºå–å¤–åŒ¯\n(2) ç‚ºæœ¬åœ°å±…æ°‘æä¾›å°±æ¥­æ©Ÿæœƒ\n(3) ç‚ºæ”¿åºœå¸¶ä¾†ç¨…æ”¶",
                options: ["åªæœ‰ (1) åŠ (2)", "åªæœ‰ (1) åŠ (3)", "åªæœ‰ (2) åŠ (3)", "(1)ã€(2) åŠ (3)"],
                answer: 3, explanation: "å•†æ¥­æ´»å‹•èƒ½ä¿ƒé€²å‡ºå£è³ºå–å¤–åŒ¯ã€å‰µé€ å°±æ¥­è·ä½ä»¥åŠå¢åŠ æ”¿åºœåˆ©å¾—ç¨…æ”¶å…¥ï¼Œä¸‰è€…çš†æ­£ç¢ºã€‚"
            }
            // ...å…¶ä»–éœæ…‹é¡Œç›®çœç•¥ï¼Œé›²ç«¯å„ªå…ˆ
        ];

        // é€™æ˜¯å…¨åŸŸè®Šæ•¸ï¼Œæœƒæ··åˆæœ¬åœ°é¡Œç›® + é›²ç«¯é¡Œç›®
        window.BAFS_DB = [...REAL_QUESTIONS];
        let CLOUD_QUESTIONS_CACHE = [];

        // === 2. FIREBASE CONFIG è¨­å®šå€ ===
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBt7EdhDqdpNQuh1jo6AmCNO3Vgso-c8pg",
            authDomain: "bafs-140c4.firebaseapp.com",
            projectId: "bafs-140c4",
            storageBucket: "bafs-140c4.firebasestorage.app",
            messagingSenderId: "859626093746",
            appId: "1:859626093746:web:8e0ffb9616bce754d0ddab"
        }; 

        const firebaseConfig = YOUR_FIREBASE_CONFIG || JSON.parse(new URLSearchParams(window.location.search).get('__firebase_config') || '{}');
        
        let db, auth, user;
        // Robust appId handling
        let appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.projectId || 'default-app-id');

        try {
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // ç›£è½ç™»å…¥ç‹€æ…‹
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    appLogic.updateAuthUI(u);
                    
                    if(u) {
                        // ç™»å…¥å¾Œè¼‰å…¥é›²ç«¯æ•¸æ“š
                        document.getElementById('auth-modal').classList.add('hidden'); // Close modal on success
                        appLogic.loadCloudQuestions();
                        appLogic.loadCloudStats();
                        const statusEl = document.getElementById('firebase-status');
                        if(statusEl) {
                            statusEl.innerText = "Firebase é€£æ¥æˆåŠŸ";
                            statusEl.classList.remove('text-red-500');
                            statusEl.classList.add('text-green-500');
                        }
                    } else {
                         // å¼·åˆ¶ç™»å…¥: å¦‚æœæœªç™»å…¥ï¼Œé¡¯ç¤º Modal ä¸”ä¸çµ¦é—œé–‰
                         appLogic.openAuthModal(true);
                    }
                });
            } else {
                console.warn("No Firebase Config found. App running in static mode.");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // === 3. APP LOGIC ===
        class BAFSApp {
            constructor() {
                this.currentQuestions = [];
                this.currentIndex = 0;
                this.score = 0;
                this.mode = 'practice';
                this.userAnswers = {};
                this.timerInterval = null;
                this.timeRemaining = 75 * 60;
                this.selectedYear = null;
                this.mistakes = JSON.parse(localStorage.getItem('bafs_mistakes')) || [];
                this.stats = JSON.parse(localStorage.getItem('bafs_stats')) || { total: 0, correct: 0 };
                this.isRegisterMode = false;
                this.currentEditingId = null; // null = add mode, string = edit mode ID
                
                this.init();
            }

            init() {
                // åˆæ¬¡æ¸²æŸ“ (åªé¡¯ç¤ºéœæ…‹é¡Œç›®)
                this.renderYears();
                this.updateStatsUI();
            }

            // --- Auth Logic ---
            openAuthModal(isMandatory = false) {
                const modal = document.getElementById('auth-modal');
                const closeBtn = document.getElementById('auth-close-btn');
                
                modal.classList.remove('hidden');
                
                if (isMandatory) {
                    closeBtn.classList.add('hidden'); // éš±è—é—œé–‰æŒ‰éˆ•ï¼Œå¼·åˆ¶ç™»å…¥
                } else {
                    closeBtn.classList.remove('hidden');
                }
            }

            toggleAuthMode() {
                this.isRegisterMode = !this.isRegisterMode;
                const title = document.getElementById('auth-title');
                const btn = document.getElementById('auth-submit-text');
                const toggle = document.getElementById('auth-toggle-text');
                
                if (this.isRegisterMode) {
                    title.innerText = "è¨»å†Šæ–°å¸³è™Ÿ";
                    btn.innerText = "ç«‹å³è¨»å†Š";
                    toggle.innerHTML = `å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ <button onclick="app.toggleAuthMode()" class="text-brand-blue font-bold underline">ç™»å…¥</button>`;
                } else {
                    title.innerText = "ç™»å…¥å¸³è™Ÿ";
                    btn.innerText = "ç«‹å³ç™»å…¥";
                    toggle.innerHTML = `é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <button onclick="app.toggleAuthMode()" class="text-brand-blue font-bold underline">å…è²»è¨»å†Š</button>`;
                }
            }

            async handleAuthSubmit() {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;

                if (!email || !password) return;

                try {
                    if (this.isRegisterMode) {
                        await createUserWithEmailAndPassword(auth, email, password);
                        this.showToast("è¨»å†ŠæˆåŠŸï¼æ­¡è¿åŠ å…¥ç‹€å…ƒå·¥å» ï¼");
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                        this.showToast("ç™»å…¥æˆåŠŸï¼");
                    }
                } catch (error) {
                    console.error(error);
                    let msg = "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                    if (error.code === 'auth/wrong-password') msg = "å¯†ç¢¼éŒ¯èª¤ï¼";
                    if (error.code === 'auth/user-not-found') msg = "æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿï¼Œè«‹å…ˆè¨»å†Šã€‚";
                    if (error.code === 'auth/email-already-in-use') msg = "æ­¤ Email å·²è¢«è¨»å†Šã€‚";
                    if (error.code === 'auth/invalid-email') msg = "Email æ ¼å¼ä¸æ­£ç¢ºã€‚";
                    if (error.code === 'auth/weak-password') msg = "å¯†ç¢¼å¤ªå¼±ï¼Œè«‹è‡³å°‘è¼¸å…¥ 6 ä½æ•¸ã€‚";
                    alert(msg);
                }
            }

            async handleLogout() {
                if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                    await signOut(auth);
                    this.showToast("å·²ç™»å‡º");
                    setTimeout(() => window.location.reload(), 500);
                }
            }

            updateAuthUI(user) {
                const loginBtn = document.getElementById('btn-login-nav');
                const logoutBtn = document.getElementById('btn-logout-nav');
                const userDisplay = document.getElementById('user-display');
                
                if (user) {
                    loginBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    userDisplay.classList.remove('hidden');
                    document.getElementById('username-span').innerText = user.email ? user.email.split('@')[0] : 'User';
                } else {
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    userDisplay.classList.add('hidden');
                }
            }

            // --- Database Sync & Management ---
            async loadCloudQuestions() {
                if (!db) return;
                try {
                    const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                    const snapshot = await getDocs(qRef);
                    
                    CLOUD_QUESTIONS_CACHE = [];
                    snapshot.forEach(doc => {
                        // Tag cloud questions with isCloud: true and their Firestore doc id
                        CLOUD_QUESTIONS_CACHE.push({ ...doc.data(), id: doc.id, isCloud: true });
                    });

                    window.BAFS_DB = [...REAL_QUESTIONS, ...CLOUD_QUESTIONS_CACHE];
                    
                    this.renderYears();
                    this.renderAdminQuestionList(); // Update admin list
                } catch (e) {
                    console.error("Failed to load cloud questions:", e);
                    const statusEl = document.getElementById('firebase-status');
                    if(statusEl) {
                        statusEl.innerText = "âš ï¸ é€£ç·šè­¦å‘Š: ç„¡æ³•è¼‰å…¥é¡Œç›®";
                        statusEl.classList.remove('text-green-500');
                        statusEl.classList.add('text-yellow-600');
                    }
                }
            }
            
            // Render the list of manageable questions in admin panel
            renderAdminQuestionList() {
                const list = document.getElementById('admin-q-list');
                if(!list) return;
                list.innerHTML = '';

                // Filter only cloud questions as static ones can't be edited via DB
                const manageList = CLOUD_QUESTIONS_CACHE.sort((a,b) => b.createdAt - a.createdAt);

                if (manageList.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-4">æš«ç„¡é›²ç«¯é¡Œç›®</div>';
                    return;
                }

                manageList.forEach(q => {
                    const item = document.createElement('div');
                    item.className = "border-2 border-gray-200 dark:border-gray-600 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition flex justify-between items-center group";
                    item.innerHTML = `
                        <div class="flex-1 pr-2">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="bg-brand-blue text-white text-xs px-2 py-0.5 rounded font-bold">${q.year}</span>
                                <span class="text-xs text-gray-500">${q.topic}</span>
                            </div>
                            <p class="text-sm line-clamp-1 font-bold">${q.question}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="app.editCloudQuestion('${q.id}')" class="text-blue-500 hover:text-blue-700 p-2" title="ç·¨è¼¯">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="app.deleteCloudQuestion('${q.id}')" class="text-red-500 hover:text-red-700 p-2" title="åˆªé™¤">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }

            // Fill form for editing
            editCloudQuestion(id) {
                const q = CLOUD_QUESTIONS_CACHE.find(item => item.id === id);
                if (!q) return;

                this.currentEditingId = id;
                
                // Switch UI to Edit Mode
                document.getElementById('form-mode-title').innerText = "ç·¨è¼¯é¡Œç›®";
                document.getElementById('btn-cancel-edit').classList.remove('hidden');
                const btnSubmit = document.getElementById('btn-submit-q');
                btnSubmit.innerHTML = '<i class="fa-solid fa-floppy-disk mr-2"></i>æ›´æ–°é¡Œç›®';
                btnSubmit.classList.remove('bg-brand-green', 'hover:bg-green-600');
                btnSubmit.classList.add('bg-brand-blue', 'hover:bg-blue-600');

                // Fill values
                document.getElementById('admin-year').value = q.year;
                document.getElementById('admin-topic').value = q.topic;
                document.getElementById('admin-q-text').value = q.question;
                document.getElementById('admin-opt-0').value = q.options[0];
                document.getElementById('admin-opt-1').value = q.options[1];
                document.getElementById('admin-opt-2').value = q.options[2];
                document.getElementById('admin-opt-3').value = q.options[3];
                document.getElementById('admin-expl').value = q.explanation;
                
                // Radio
                const radios = document.getElementsByName('admin-ans');
                if(radios[q.answer]) radios[q.answer].checked = true;

                // Scroll to top of form
                document.getElementById('admin-view').scrollIntoView({ behavior: 'smooth' });
            }

            resetAdminForm() {
                this.currentEditingId = null;
                document.getElementById('add-q-form').reset();
                
                // Reset UI
                document.getElementById('form-mode-title').innerText = "æ–°å¢é¡Œç›®";
                document.getElementById('btn-cancel-edit').classList.add('hidden');
                const btnSubmit = document.getElementById('btn-submit-q');
                btnSubmit.innerHTML = '<i class="fa-solid fa-cloud-arrow-up mr-2"></i>ç™¼å¸ƒåˆ°é›²ç«¯é¡Œåº«';
                btnSubmit.classList.remove('bg-brand-blue', 'hover:bg-blue-600');
                btnSubmit.classList.add('bg-brand-green', 'hover:bg-green-600');
            }

            async deleteCloudQuestion(id) {
                if(!confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™æ¢é¡Œç›®å—ï¼Ÿ")) return;
                
                if (!db || !user) return;

                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'questions', id);
                    await deleteDoc(docRef);
                    this.showToast("é¡Œç›®å·²åˆªé™¤");
                    this.loadCloudQuestions(); // Reload list
                    
                    // If editing the deleted one, reset form
                    if(this.currentEditingId === id) this.resetAdminForm();
                } catch(e) {
                    console.error(e);
                    alert("åˆªé™¤å¤±æ•—: " + e.message);
                }
            }

            // Unified handler for Add/Edit
            async handleQuestionSubmit() {
                if (!db || !user) {
                    this.openAuthModal();
                    return;
                }

                // Gather data
                const year = document.getElementById('admin-year').value.trim();
                const topic = document.getElementById('admin-topic').value;
                const question = document.getElementById('admin-q-text').value.trim();
                const opts = [
                    document.getElementById('admin-opt-0').value.trim(),
                    document.getElementById('admin-opt-1').value.trim(),
                    document.getElementById('admin-opt-2').value.trim(),
                    document.getElementById('admin-opt-3').value.trim(),
                ];
                const ans = parseInt(document.querySelector('input[name="admin-ans"]:checked').value);
                const expl = document.getElementById('admin-expl').value.trim();

                if(!year || !question || opts.some(o=>!o) || !expl) {
                    alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼");
                    return;
                }

                const qData = {
                    year, topic, question, 
                    options: opts, 
                    answer: ans, 
                    explanation: expl,
                    lastUpdated: serverTimestamp(),
                    author: user.uid
                };

                try {
                    const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                    
                    if (this.currentEditingId) {
                        // UPDATE mode
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'questions', this.currentEditingId);
                        await updateDoc(docRef, qData);
                        this.showToast("é¡Œç›®æ›´æ–°æˆåŠŸï¼");
                    } else {
                        // CREATE mode
                        qData.createdAt = serverTimestamp();
                        await addDoc(collectionRef, qData);
                        this.showToast("é¡Œç›®å·²ç™¼å¸ƒï¼");
                    }
                    
                    this.resetAdminForm();
                    this.loadCloudQuestions();
                } catch (e) {
                    console.error(e);
                    alert("æ“ä½œå¤±æ•—: " + e.message);
                }
            }
            
            // --- NEW: Handle Bulk Import ---
            async handleBulkImport() {
                // AUTH CHECK FIX: Ensure user is logged in
                if (!db || !user) {
                    this.showToast("è«‹å…ˆç™»å…¥æ‰èƒ½åŒ¯å…¥é¡Œç›®ï¼");
                    this.openAuthModal();
                    return;
                }

                const jsonStr = document.getElementById('bulk-import-area').value.trim();
                if(!jsonStr) { alert("è«‹è²¼ä¸Š JSON ä»£ç¢¼"); return; }
                
                try {
                    const data = JSON.parse(jsonStr);
                    if(!Array.isArray(data)) throw new Error("JSON å¿…é ˆæ˜¯ä¸€å€‹é™£åˆ— (Array) []");
                    
                    if(!confirm(`æº–å‚™åŒ¯å…¥ ${data.length} æ¢é¡Œç›®ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;
                    
                    this.showToast("æ­£åœ¨åŒ¯å…¥ä¸­ï¼Œè«‹ç¨å€™...");
                    let count = 0;
                    
                    for(const q of data) {
                        // Remove id from data body to prevent id field duplication inside doc
                        // But use it as doc ID
                        const qId = q.id ? String(q.id) : null;
                        const qPayload = { ...q, author: user.uid, createdAt: serverTimestamp() };
                        delete qPayload.id; // clean up
                        
                        if(qId) {
                            // Use setDoc to merge/overwrite with specific ID (prevents duplicates)
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'questions', qId), qPayload);
                        } else {
                            // Auto ID
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'questions'), qPayload);
                        }
                        count++;
                    }
                    
                    alert(`æˆåŠŸåŒ¯å…¥ ${count} æ¢é¡Œç›®ï¼`);
                    document.getElementById('bulk-import-area').value = ''; // clear
                    this.loadCloudQuestions();
                    
                } catch(e) {
                    console.error(e);
                    alert("åŒ¯å…¥å¤±æ•—ï¼š\n" + e.message + "\n\nå¸¸è¦‹åŸå› ï¼šJSON æ ¼å¼æœ‰èª¤ï¼Œæˆ–è€…æ‚¨æœªç™»å…¥ã€‚");
                }
            }
            
            // OCR Logic
            async handleOCR(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    const statusDiv = document.getElementById('ocr-status');
                    const progressSpan = document.getElementById('ocr-progress');
                    
                    statusDiv.classList.remove('hidden');
                    progressSpan.innerText = "0%";

                    Tesseract.recognize(
                        file,
                        'chi_tra+eng', // Traditional Chinese + English
                        {
                            logger: m => {
                                if(m.status === 'recognizing text') {
                                    progressSpan.innerText = Math.round(m.progress * 100) + '%';
                                }
                            }
                        }
                    ).then(({ data: { text } }) => {
                        statusDiv.classList.add('hidden');
                        
                        // Try to structure basic JSON template from text
                        const template = `[
  {
    "year": "2024",
    "topic": "OCR_Topic",
    "question": ${JSON.stringify(text.trim())},
    "options": ["A", "B", "C", "D"],
    "answer": 0,
    "explanation": ""
  }
]`;
                        document.getElementById('bulk-import-area').value = template;
                        this.showToast("æ–‡å­—è¾¨è­˜å®Œæˆï¼è«‹æª¢æŸ¥ä¸¦ä¿®æ­£ JSONã€‚");
                    });
                }
            }
            
            copyTemplate() {
                const tpl = `[
  {
    "id": 202401,
    "year": "2024",
    "topic": "Business Environment",
    "question": "é¡Œç›®å…§å®¹...",
    "options": ["Aé¸é …", "Bé¸é …", "Cé¸é …", "Dé¸é …"],
    "answer": 0,
    "explanation": "è©³è§£..."
  },
  {
    "id": 202402,
    "year": "2024",
    "topic": "Accounting",
    "question": "é¡Œç›®2...",
    "options": ["A", "B", "C", "D"],
    "answer": 1,
    "explanation": "è©³è§£2..."
  }
]`;
                document.getElementById('bulk-import-area').value = tpl;
            }

            // Test Connection
            async testConnection() {
                const statusEl = document.getElementById('firebase-status');
                statusEl.innerText = "æ­£åœ¨æ¸¬è©¦é€£ç·š...";
                statusEl.className = "text-xs font-bold mt-2 text-yellow-600";
                
                if (!db) {
                    statusEl.innerText = "éŒ¯èª¤: Firebase SDK æœªåˆå§‹åŒ–";
                    statusEl.className = "text-xs font-bold mt-2 text-red-500";
                    return;
                }
                
                if (!user) {
                    statusEl.innerText = "éŒ¯èª¤: ä½¿ç”¨è€…æœªç™»å…¥";
                    statusEl.className = "text-xs font-bold mt-2 text-red-500";
                    return;
                }

                try {
                    // Try to fetch 1 document
                    const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                    await getDocs(query(qRef, limit(1)));
                    
                    statusEl.innerText = "âœ… é€£ç·šæˆåŠŸï¼è³‡æ–™åº«é‹ä½œæ­£å¸¸ã€‚";
                    statusEl.className = "text-xs font-bold mt-2 text-green-600";
                    this.loadCloudQuestions(); // Reload to be sure
                    alert("âœ… é€£ç·šæˆåŠŸï¼å¯ä»¥æ­£å¸¸è®€å¯«è³‡æ–™åº«ã€‚");
                    
                } catch (e) {
                    console.error(e);
                    statusEl.innerText = "âŒ é€£ç·šå¤±æ•—: " + e.message;
                    statusEl.className = "text-xs font-bold mt-2 text-red-500";
                    alert("é€£ç·šå¤±æ•—ï¼è«‹ç¢ºä¿ Firebase Console ä¸­çš„ Firestore Rules å·²è¨­ç‚º Test Modeã€‚");
                }
            }

            generateJSONExport() {
                const area = document.getElementById('json-export-area');
                area.classList.remove('hidden');
                const json = JSON.stringify(window.BAFS_DB, null, 4);
                area.value = json;
                area.select();
                document.execCommand('copy');
                this.showToast("JSON å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
            }

            // --- Navigation ---
            router(viewId) {
                document.querySelectorAll('.hidden-page, #home-view').forEach(el => {
                    if(el.id !== 'mobile-menu') el.style.display = 'none';
                });
                
                const target = document.getElementById(viewId + '-view');
                if (target) {
                    target.style.display = 'block';
                    window.scrollTo(0, 0);
                    
                    if(viewId === 'mistakes') this.renderMistakes();
                    if(viewId === 'leaderboard') this.loadLeaderboard();
                    if(viewId === 'admin') this.renderAdminQuestionList(); // Refresh list on enter
                }
            }

            toggleDarkMode() {
                document.documentElement.classList.toggle('dark');
            }

            showToast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.style.transform = 'translate(-50%, 0)';
                setTimeout(() => {
                    t.style.transform = 'translate(-50%, 5rem)';
                }, 3000);
            }

            // --- Home & Selection ---
            renderYears() {
                const grid = document.getElementById('year-grid');
                grid.innerHTML = '';
                
                const years = [...new Set(window.BAFS_DB.map(q => q.year))].sort().reverse();
                
                if (years.length === 0) {
                    grid.innerHTML = '<div class="col-span-3 text-center text-gray-500">æš«ç„¡é¡Œç›®ï¼Œè«‹åˆ°ç®¡ç†å“¡å¾Œå°æ–°å¢ã€‚</div>';
                    return;
                }

                years.forEach(year => {
                    const btn = document.createElement('button');
                    btn.className = "cartoon-card p-4 hover:bg-brand-blue hover:text-white font-bold text-lg transition duration-200 flex flex-col items-center justify-center h-24 dark:text-gray-900";
                    btn.innerHTML = `
                        <span>${year}</span>
                        <span class="text-xs font-normal opacity-70 mt-1">ç·´ç¿’</span>
                    `;
                    btn.onclick = () => this.openModeModal(year);
                    grid.appendChild(btn);
                });
            }

            openModeModal(year) {
                this.selectedYear = year;
                document.getElementById('modal-year-title').innerText = `${year} MC Paper 1`;
                document.getElementById('mode-modal').classList.remove('hidden');
            }

            handleSearch() {
                const term = document.getElementById('search-input').value.trim().toLowerCase();
                if (!term) return;

                const results = window.BAFS_DB.filter(q => 
                    (q.question && q.question.toLowerCase().includes(term)) || 
                    (q.explanation && q.explanation.toLowerCase().includes(term))
                );

                if (results.length === 0) {
                    this.showToast("æ‰¾ä¸åˆ°ç›¸é—œé¡Œç›®ï¼");
                    return;
                }

                this.currentQuestions = results;
                this.selectedYear = `æœå°‹: "${term}"`;
                this.startQuiz('practice', true);
            }

            startRandomMock() {
                if (window.BAFS_DB.length === 0) {
                    this.showToast("é¡Œåº«æ˜¯ç©ºçš„ï¼");
                    return;
                }
                const shuffled = [...window.BAFS_DB].sort(() => 0.5 - Math.random());
                this.currentQuestions = shuffled.slice(0, 45); 
                this.selectedYear = "éš¨æ©Ÿæ¨¡æ“¬å·";
                this.openModeModal("éš¨æ©Ÿæ¨¡æ“¬å·"); 
            }

            // --- Quiz Logic ---
            startQuiz(mode, isSearch = false) {
                document.getElementById('mode-modal').classList.add('hidden');
                this.mode = mode;
                
                if (!isSearch && this.selectedYear !== "éš¨æ©Ÿæ¨¡æ“¬å·") {
                    this.currentQuestions = window.BAFS_DB.filter(q => q.year === this.selectedYear);
                }

                if (this.currentQuestions.length === 0) {
                    this.showToast("æ­¤å¹´ä»½æš«ç„¡é¡Œç›®");
                    return;
                }

                this.currentIndex = 0;
                this.score = 0;
                this.userAnswers = {};
                this.router('quiz');

                document.getElementById('quiz-title').innerText = this.selectedYear;
                document.getElementById('quiz-mode-label').innerText = mode === 'exam' ? 'MOCK EXAM MODE' : 'PRACTICE MODE';
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('btn-submit').classList.add('hidden');

                const timerDisplay = document.getElementById('timer-display');
                if (mode === 'exam') {
                    this.timeRemaining = 75 * 60;
                    timerDisplay.classList.remove('hidden');
                    this.startTimer();
                } else {
                    timerDisplay.classList.add('hidden');
                    clearInterval(this.timerInterval);
                }

                this.renderQuestion();
            }

            startTimer() {
                clearInterval(this.timerInterval);
                const display = document.getElementById('timer-display');
                
                this.timerInterval = setInterval(() => {
                    this.timeRemaining--;
                    const m = Math.floor(this.timeRemaining / 60);
                    const s = this.timeRemaining % 60;
                    display.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                    
                    if (this.timeRemaining <= 0) {
                        this.endQuizEarly();
                    }
                }, 1000);
            }

            renderQuestion() {
                const q = this.currentQuestions[this.currentIndex];
                const total = this.currentQuestions.length;
                
                document.getElementById('q-number').innerText = `${this.currentIndex + 1}/${total}`;
                document.getElementById('q-text').innerText = q.question;
                
                const pct = ((this.currentIndex) / total) * 100;
                document.getElementById('quiz-progress').style.width = `${pct}%`;

                const optsContainer = document.getElementById('q-options');
                optsContainer.innerHTML = '';
                
                q.options.forEach((opt, idx) => {
                    const isSelected = this.userAnswers[q.id || this.currentIndex] === idx; 
                    const qId = q.id || this.currentIndex;

                    const label = document.createElement('label');
                    label.className = "cursor-pointer block relative group";
                    label.innerHTML = `
                        <input type="radio" name="opt" class="hidden option-input" value="${idx}" ${isSelected ? 'checked' : ''} onchange="app.selectOption(${idx})">
                        <div class="p-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 hover:border-black dark:hover:border-white transition flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full border-2 border-gray-400 flex items-center justify-center font-bold text-gray-500 group-hover:bg-black group-hover:text-white transition-colors">
                                ${String.fromCharCode(65 + idx)}
                            </span>
                            <span class="text-lg">${opt}</span>
                        </div>
                    `;
                    optsContainer.appendChild(label);
                });

                document.getElementById('explanation-box').classList.add('hidden');
                
                document.getElementById('btn-prev').disabled = this.currentIndex === 0;
                
                if (this.currentIndex === total - 1) {
                    document.getElementById('btn-next').classList.add('hidden');
                    document.getElementById('btn-submit').classList.remove('hidden');
                } else {
                    document.getElementById('btn-next').classList.remove('hidden');
                    document.getElementById('btn-submit').classList.add('hidden');
                }

                const qId = q.id || this.currentIndex;
                if (this.mode === 'practice' && this.userAnswers[qId] !== undefined) {
                    this.showFeedback(q, this.userAnswers[qId]);
                }
            }

            selectOption(idx) {
                const q = this.currentQuestions[this.currentIndex];
                const qId = q.id || this.currentIndex;
                
                if (this.mode === 'practice' && this.userAnswers[qId] !== undefined) return;
                
                this.userAnswers[qId] = idx;

                if (this.mode === 'practice') {
                    this.showFeedback(q, idx);
                }
            }

            showFeedback(q, selectedIdx) {
                const isCorrect = selectedIdx === q.answer;
                const opts = document.querySelectorAll('.option-input + div');
                
                opts[selectedIdx].classList.remove('border-gray-300', 'border-black');
                opts[selectedIdx].classList.add(isCorrect ? 'bg-green-100' : 'bg-red-100', isCorrect ? 'border-green-500' : 'border-red-500', 'text-black');
                
                if (!isCorrect) {
                    opts[q.answer].classList.add('bg-green-100', 'border-green-500', 'text-black');
                    this.addMistake(q);
                }

                const expBox = document.getElementById('explanation-box');
                document.getElementById('explanation-text').innerText = q.explanation;
                expBox.classList.remove('hidden');

                document.querySelectorAll('input[type="radio"]').forEach(el => el.disabled = true);
            }

            nextQuestion() {
                if (this.currentIndex < this.currentQuestions.length - 1) {
                    this.currentIndex++;
                    this.renderQuestion();
                }
            }

            prevQuestion() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.renderQuestion();
                }
            }

            addMistake(question) {
                const qId = question.id || question.question; 
                if (!this.mistakes.find(m => (m.id || m.question) === qId)) {
                    this.mistakes.push(question);
                    localStorage.setItem('bafs_mistakes', JSON.stringify(this.mistakes));
                }
            }

            endQuizEarly() {
                if(confirm("ç¢ºå®šçµæŸç·´ç¿’ä¸¦æŸ¥çœ‹æˆç¸¾ï¼Ÿ")) {
                    this.submitQuiz();
                }
            }

            submitQuiz() {
                clearInterval(this.timerInterval);
                
                let correctCount = 0;
                this.currentQuestions.forEach(q => {
                    const key = q.id || this.currentQuestions.indexOf(q);
                    const userAns = this.userAnswers[q.id];
                    
                    if (userAns === q.answer) {
                        correctCount++;
                    } else if (this.mode === 'exam' && userAns !== undefined) {
                        this.addMistake(q);
                    }
                });

                this.score = correctCount;
                const total = this.currentQuestions.length;
                
                this.stats.total += total;
                this.stats.correct += correctCount;
                localStorage.setItem('bafs_stats', JSON.stringify(this.stats));
                this.updateStatsUI();

                document.getElementById('result-subtitle').innerText = `${this.selectedYear} â€¢ ${this.mode === 'exam' ? 'æ¨¡æ“¬è€ƒ' : 'ç·´ç¿’'}`;
                document.getElementById('result-score').innerText = this.score;
                document.getElementById('result-total').innerText = total;
                document.getElementById('result-correct').innerText = correctCount;
                document.getElementById('result-wrong').innerText = total - correctCount;

                this.router('result');
                
                if (correctCount / total > 0.5) {
                    this.fireConfetti();
                }

                // è‡ªå‹•ä¸Šå‚³åˆ†æ•¸ (Auto Upload)
                if (user) {
                    this.saveToLeaderboard(true);
                }
            }

            fireConfetti() {
                for(let i=0; i<50; i++) {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.backgroundColor = ['#FFD93D', '#4D96FF', '#FF6B6B'][Math.floor(Math.random()*3)];
                    c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 4000);
                }
            }

            renderMistakes() {
                const list = document.getElementById('mistakes-list');
                const emptyMsg = document.getElementById('no-mistakes-msg');
                list.innerHTML = '';

                if (this.mistakes.length === 0) {
                    emptyMsg.classList.remove('hidden');
                    return;
                }
                emptyMsg.classList.add('hidden');

                this.mistakes.forEach(q => {
                    const div = document.createElement('div');
                    div.className = "cartoon-card p-6 bg-white dark:bg-gray-800 relative";
                    div.innerHTML = `
                        <div class="absolute top-4 right-4 text-xs font-bold text-gray-400">${q.year}</div>
                        <h4 class="font-bold text-lg mb-3 pr-8">${q.question}</h4>
                        <div class="space-y-2 mb-4">
                            ${q.options.map((opt, i) => `
                                <div class="px-3 py-2 rounded border ${i === q.answer ? 'bg-green-100 border-green-500 text-black' : 'border-gray-200 dark:border-gray-600'}">
                                    ${String.fromCharCode(65+i)}. ${opt}
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-sm bg-blue-50 dark:bg-blue-900/20 p-3 rounded text-brand-blue dark:text-blue-300">
                            <strong>è©³è§£ï¼š</strong> ${q.explanation}
                        </div>
                        <button class="mt-4 text-xs text-red-500 underline font-bold" onclick="app.removeMistake('${q.id}')">ç§»é™¤æ­¤é¡Œ</button>
                    `;
                    list.appendChild(div);
                });
            }

            removeMistake(id) {
                this.mistakes = this.mistakes.filter(m => m.id != id); 
                localStorage.setItem('bafs_mistakes', JSON.stringify(this.mistakes));
                this.renderMistakes();
                this.updateStatsUI();
            }

            clearMistakes() {
                if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰éŒ¯é¡Œï¼Ÿ")) {
                    this.mistakes = [];
                    localStorage.setItem('bafs_mistakes', JSON.stringify([]));
                    this.renderMistakes();
                    this.updateStatsUI();
                }
            }

            updateStatsUI() {
                document.getElementById('stat-total-done').innerText = this.stats.total;
                const acc = this.stats.total === 0 ? 0 : Math.round((this.stats.correct / this.stats.total) * 100);
                document.getElementById('stat-accuracy').innerText = acc + '%';
                document.getElementById('stat-mistakes').innerText = this.mistakes.length;
            }

            shareResult() {
                const text = `æˆ‘å‰›åœ¨ BAFS ç‹€å…ƒå·¥å»  (${this.selectedYear}) æ‹¿åˆ° ${this.score}/${this.currentQuestions.length} åˆ†ï¼å¿«ä¾†æŒ‘æˆ°ï¼`;
                if (navigator.share) {
                    navigator.share({ title: 'BAFS æˆç¸¾', text: text, url: window.location.href });
                } else {
                    navigator.clipboard.writeText(text);
                    this.showToast("æˆç¸¾å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
                }
            }

            // Modified to support Auto-Upload
            async saveToLeaderboard(isAuto = false) {
                if (!user) {
                    if(!isAuto) {
                        this.showToast("è«‹å…ˆç™»å…¥æ‰èƒ½ä¸Šå‚³æˆç¸¾ï¼");
                        this.openAuthModal();
                    }
                    return;
                }
                
                let nickname;
                if (isAuto) {
                    // è‡ªå‹•æ¨¡å¼ï¼šä½¿ç”¨ Email å‰ç¶´
                    nickname = user.email.split('@')[0];
                } else {
                    // æ‰‹å‹•æ¨¡å¼ï¼šè©¢å•
                    nickname = prompt("è«‹è¼¸å…¥ä½ åœ¨é¾è™æ¦œä¸Šçš„æš±ç¨±ï¼š", user.email.split('@')[0]);
                }
                
                if (!nickname) return;

                const acc = Math.round((this.score / this.currentQuestions.length) * 100);

                try {
                    const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                    await addDoc(scoresRef, {
                        nickname: nickname,
                        score: this.score,
                        accuracy: acc,
                        year: this.selectedYear,
                        timestamp: serverTimestamp()
                    });
                    
                    if (isAuto) {
                        document.getElementById('auto-upload-msg').classList.remove('hidden');
                    } else {
                        this.showToast("ä¸Šå‚³æˆåŠŸï¼");
                        setTimeout(() => this.router('leaderboard'), 1000);
                    }
                } catch (e) {
                    console.error(e);
                    if (!isAuto) this.showToast("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«è¦å‰‡ã€‚");
                }
            }

            async loadLeaderboard() {
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">è¼‰å…¥ä¸­...</td></tr>';
                
                try {
                    const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                    const q = query(scoresRef); 
                    const querySnapshot = await getDocs(q);
                    
                    let data = [];
                    querySnapshot.forEach((doc) => {
                        data.push(doc.data());
                    });

                    data.sort((a, b) => b.score - a.score);
                    data = data.slice(0, 50);

                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">æš«ç„¡æ•¸æ“šï¼Œå¿«ä¾†æ¶ç¬¬ä¸€ï¼</td></tr>';
                        return;
                    }

                    data.forEach((entry, idx) => {
                        let rankClass = "";
                        let icon = "";
                        if (idx === 0) { rankClass = "text-brand-yellow font-bold text-xl"; icon = "ğŸ‘‘"; }
                        else if (idx === 1) { rankClass = "text-gray-400 font-bold text-lg"; icon = "ğŸ¥ˆ"; }
                        else if (idx === 2) { rankClass = "text-orange-400 font-bold text-lg"; icon = "ğŸ¥‰"; }

                        const row = `
                            <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="p-4 ${rankClass}">${icon} ${idx + 1}</td>
                                <td class="p-4 font-bold">${entry.nickname}</td>
                                <td class="p-4 text-sm text-gray-500 hidden md:table-cell">${entry.year}</td>
                                <td class="p-4 text-right font-mono font-bold text-brand-blue">${entry.score}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });

                } catch (e) {
                    console.error(e);
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">ç„¡æ³•è¼‰å…¥é¾è™æ¦œ</td></tr>';
                }
            }

            async loadCloudStats() {
                if(!user) return;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', 'main');
                    // Future sync logic
                } catch(e) { }
            }
        }

        window.app = new BAFSApp();
        window.router = (view) => app.router(view);

    </script>
</body>
</html>